<!DOCTYPE html>
<html lang=\"en\">
<head>
  <meta charset=\"UTF-8\" />
  <title>BlackFog TTX - Facilitator</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 50%);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      background: rgba(2,6,23,0.9);
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 2fr 1.6fr;
      gap: 16px;
      padding: 16px 20px 8px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #9ca3af;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    select, button, textarea {
      font-family: inherit;
      font-size: 13px;
    }
    select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 4px 10px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.15s ease, transform 0.1s ease;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #374151;
      color: #e5e7eb;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }
    .scenario-desc {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 4px;
      white-space: pre-wrap;
    }
    .meta {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }
    .inject-list {
      max-height: 200px;
      overflow-y: auto;
      padding-top: 4px;
      border-top: 1px dashed #111827;
      margin-top: 4px;
    }
    .inject-item {
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      background: #020617;
      opacity: 0.8;
    }
    .inject-item.current {
      border: 1px solid #2563eb;
      background: radial-gradient(circle at top left, rgba(37,99,235,0.18), #020617 55%);
      opacity: 1;
    }
    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 6px;
      background: #111827;
      margin-left: 4px;
    }
    .current-inject {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.5;
    }
    .votes {
      font-size: 12px;
      line-height: 1.5;
    }
    .badge {
      display: inline-block;
      min-width: 22px;
      text-align: center;
      border-radius: 999px;
      padding: 2px 6px;
      background: #020617;
      margin-right: 6px;
    }
    .majority-label {
      margin-top: 4px;
      font-size: 11px;
      opacity: 0.9;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      background: #020617;
      color: #e5e7eb;
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px;
    }
    .players {
      font-size: 12px;
      max-height: 130px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    footer {
      font-size: 11px;
      opacity: 0.75;
      padding: 6px 20px 10px;
      border-top: 1px solid #111827;
      background: rgba(2,6,23,0.95);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    #newsTicker {
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      font-size: 11px;
      opacity: 0.9;
    }
    #sessionHint {
      font-size: 10px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <header>
    <h1>BLACKFOG TTX — FACILITATOR</h1>
    <div style=\"font-size:11px;opacity:.7;display:flex;gap:10px;align-items:center;\">
      <span>Session: <span id=\"sessionIdLabel\"></span></span>
      <span id=\"playerCountBadge\"></span>
    </div>
  </header>

  <main>
    <section>
      <div class=\"card\">
        <h2>Scenario &amp; Timeline</h2>
        <div class=\"row\">
          <label for=\"scenarioSelect\" style=\"font-size:12px;\">Scenario:</label>
          <select id=\"scenarioSelect\"></select>
          <button class=\"primary\" id=\"loadScenarioBtn\">Load</button>
        </div>
        <div id=\"scenarioDesc\" class=\"scenario-desc\"></div>
        <div id=\"runStatus\" class=\"meta\">No scenario loaded.</div>
        <div class=\"row\">
          <button class=\"primary\" id=\"sendNextBtn\" disabled>Send next inject</button>
          <button class=\"secondary\" id=\"buildAARBtn\" disabled>Build AAR &amp; broadcast</button>
        </div>
        <div id=\"injectList\" class=\"inject-list\"></div>
      </div>

      <div class=\"card\">
        <h2>Current Inject</h2>
        <div id=\"currentInjectBox\" class=\"current-inject\">No inject sent yet.</div>
      </div>
    </section>

    <section>
      <div class=\"card\">
        <h2>Votes</h2>
        <div id=\"votesBox\" class=\"votes\">No votes yet.</div>
      </div>

      <div class=\"card\">
        <h2>Connected Players</h2>
        <div id=\"playersBox\" class=\"players\">Waiting for players…</div>
      </div>

      <div class=\"card\">
        <h2>AAR Preview</h2>
        <textarea id=\"aarBox\" readonly>Click \"Build AAR & broadcast\" after the run.</textarea>
      </div>
    </section>
  </main>

  <footer>
    <div id=\"newsTicker\">Ready. Load a scenario to begin.</div>
    <div id=\"sessionHint\">Players join via <code>player.html?s=&lt;session_id&gt;</code></div>
  </footer>

  <script type=\"module\">
    import {
      sessionId,
      channel,
      listScenarios,
      getScenario,
      initVoteLog,
      registerVote,
      getTallyFor,
      buildAAR,
      computeMajority
    } from './engine.mjs';

    const sessionIdLabel = document.getElementById('sessionIdLabel');
    const playerCountBadge = document.getElementById('playerCountBadge');
    const scenarioSelect = document.getElementById('scenarioSelect');
    const loadScenarioBtn = document.getElementById('loadScenarioBtn');
    const sendNextBtn = document.getElementById('sendNextBtn');
    const buildAARBtn = document.getElementById('buildAARBtn');
    const scenarioDesc = document.getElementById('scenarioDesc');
    const runStatus = document.getElementById('runStatus');
    const injectList = document.getElementById('injectList');
    const currentInjectBox = document.getElementById('currentInjectBox');
    const votesBox = document.getElementById('votesBox');
    const playersBox = document.getElementById('playersBox');
    const aarBox = document.getElementById('aarBox');
    const newsTicker = document.getElementById('newsTicker');

    sessionIdLabel.textContent = sessionId;

    let currentScenarioId = null;
    let currentInjectIndex = -1;
    let voteLog = initVoteLog();
    const players = new Map(); // playerId -> lastSeen(ms)

    const tickerMessages = [];
    let tickerIndex = 0;

    function pushTicker(message) {
      const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      tickerMessages.unshift(`[${ts}] ${message}`);
      if (tickerMessages.length > 25) tickerMessages.length = 25;
    }

    function startTicker() {
      setInterval(() => {
        if (tickerMessages.length === 0) {
          newsTicker.textContent = 'Ready. Load a scenario to begin.';
          return;
        }
        tickerIndex = (tickerIndex + 1) % tickerMessages.length;
        newsTicker.textContent = tickerMessages[tickerIndex];
      }, 6000);
    }

    // Populate scenario dropdown
    for (const s of listScenarios()) {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.title;
      scenarioSelect.appendChild(opt);
    }

    function updateRunStatus() {
      const sc = getScenario(currentScenarioId);
      if (!sc) {
        runStatus.textContent = 'No scenario loaded.';
        return;
      }
      const total = sc.injects.length;
      if (currentInjectIndex < 0) {
        runStatus.textContent = `Scenario loaded. ${total} injects. Click "Send next inject" to begin.`;
      } else {
        runStatus.textContent = `Inject ${currentInjectIndex + 1} of ${total}.`;
        if (currentInjectIndex === total - 1) {
          runStatus.textContent += '\nEnd of scenario reached.';
        }
      }
    }

    function renderScenarioDesc() {
      const sc = getScenario(currentScenarioId);
      scenarioDesc.textContent = sc ? sc.description : '';
    }

    function renderInjectList() {
      injectList.innerHTML = '';
      const sc = getScenario(currentScenarioId);
      if (!sc) return;
      sc.injects.forEach((inj, idx) => {
        const div = document.createElement('div');
        div.className = 'inject-item' + (idx === currentInjectIndex ? ' current' : '');
        const left = document.createElement('div');
        left.textContent = `#${inj.seq} ${inj.phase}`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="pill">${inj.time}</span>`;
        div.appendChild(left);
        div.appendChild(right);
        // Linear flow only: no click handler to jump around
        injectList.appendChild(div);
      });
    }

    function renderCurrentInject(inj) {
      if (!inj) {
        currentInjectBox.textContent = 'No inject sent yet.';
        return;
      }
      const cues = inj.cues || {};
      const impactStr = (cues.impact || []).join('  ');
      const lines = [];
      lines.push(`${inj.time} • ${inj.phase}`);
      lines.push(`${cues.severity || ''} ${impactStr} ${cues.phase || ''}`);
      lines.push('');
      lines.push(inj.narrative);
      if (inj.decision) {
        lines.push('');
        lines.push('Decision: ' + inj.decision.question);
        for (const [k, v] of Object.entries(inj.decision.options || {})) {
          lines.push(`  ${k}. ${v}`);
        }
      }
      currentInjectBox.textContent = lines.join('\n');
    }

    function renderVotes(inj) {
      if (!inj) {
        votesBox.textContent = 'No votes yet.';
        return;
      }
      const tally = getTallyFor(voteLog, currentScenarioId, inj.seq);
      const majority = computeMajority(tally);
      votesBox.innerHTML =
        `<div><span class="badge">A</span>${tally.A}</div>` +
        `<div><span class="badge">B</span>${tally.B}</div>` +
        `<div><span class="badge">C</span>${tally.C}</div>` +
        `<div class="majority-label">Majority: ${majority || 'None / Split'}</div>`;
    }

    function renderPlayers() {
      const now = Date.now();
      if (players.size === 0) {
        playersBox.textContent = 'Waiting for players…';
        playerCountBadge.textContent = '';
        return;
      }
      const lines = [];
      let online = 0;
      for (const [id, ts] of players.entries()) {
        const age = now - ts;
        const isOnline = age < 90000; // 90s window
        if (isOnline) online++;
        const label = isOnline ? 'online' : 'inactive';
        lines.push(`${id} (${label}, last seen ${Math.round(age / 1000)}s ago)`);
      }
      playersBox.textContent = lines.join('\n');
      playerCountBadge.textContent = `${online} active / ${players.size} total`;
    }

    function loadScenario() {
      const id = scenarioSelect.value;
      const sc = getScenario(id);
      if (!sc) {
        currentScenarioId = null;
        currentInjectIndex = -1;
        voteLog = initVoteLog();
        scenarioDesc.textContent = '';
        currentInjectBox.textContent = 'Failed to load scenario.';
        runStatus.textContent = 'Failed to load scenario.';
        sendNextBtn.disabled = true;
        buildAARBtn.disabled = true;
        return;
      }

      currentScenarioId = id;
      currentInjectIndex = -1;
      voteLog = initVoteLog();
      renderScenarioDesc();
      renderInjectList();
      renderCurrentInject(null);
      votesBox.textContent = 'No votes yet.';
      aarBox.value = 'Click "Build AAR & broadcast" after the run.';
      sendNextBtn.disabled = false;
      buildAARBtn.disabled = false;
      updateRunStatus();

      pushTicker(`Scenario loaded: ${sc.title}`);
      channel.postMessage({
        session: sessionId,
        type: 'scenarioLoaded',
        scenarioId: currentScenarioId
      });
    }

    function sendInject() {
      const sc = getScenario(currentScenarioId);
      if (!sc) return;
      const inj = sc.injects[currentInjectIndex];
      if (!inj) return;

      renderInjectList();
      renderCurrentInject(inj);
      renderVotes(inj);
      updateRunStatus();

      if (currentInjectIndex === sc.injects.length - 1) {
        sendNextBtn.disabled = true;
      }

      pushTicker(\`Inject #\${inj.seq} sent (\${inj.phase})\`);

      channel.postMessage({
        session: sessionId,
        type: 'inject',
        scenarioId: currentScenarioId,
        injectSeq: inj.seq,
        inject
      });
    }

    function sendNextInject() {
      const sc = getScenario(currentScenarioId);
      if (!sc) return;
      if (currentInjectIndex + 1 >= sc.injects.length) {
        sendNextBtn.disabled = true;
        updateRunStatus();
        return;
      }
      currentInjectIndex += 1;
      sendInject();
    }

    function doBuildAAR() {
      if (!currentScenarioId) return;
      const text = buildAAR(currentScenarioId, voteLog);
      aarBox.value = text || 'No AAR data.';
      pushTicker('AAR built and broadcast to players.');

      channel.postMessage({
        session: sessionId,
        type: 'aar',
        scenarioId: currentScenarioId,
        aarText: aarBox.value
      });
    }

    loadScenarioBtn.addEventListener('click', loadScenario);
    sendNextBtn.addEventListener('click', sendNextInject);
    buildAARBtn.addEventListener('click', doBuildAAR);

    channel.onmessage = ev => {
      const msg = ev.data;
      if (!msg || msg.session !== sessionId) return;
      if (msg.type === 'join' || msg.type === 'ping') {
        players.set(msg.playerId, Date.now());
        // prune entries older than 10 minutes
        const now = Date.now();
        for (const [id, ts] of players.entries()) {
          if (now - ts > 10 * 60 * 1000) {
            players.delete(id);
          }
        }
        renderPlayers();
      } else if (msg.type === 'vote') {
        if (!currentScenarioId || msg.scenarioId !== currentScenarioId) return;
        registerVote(voteLog, msg.scenarioId, msg.injectSeq, msg.choice, msg.playerId);
        const sc = getScenario(currentScenarioId);
        if (!sc) return;
        const inj = sc.injects.find(i => i.seq === msg.injectSeq);
        if (inj) renderVotes(inj);
      }
    };

    // Autoload first scenario if available
    if (scenarioSelect.options.length > 0) {
      scenarioSelect.selectedIndex = 0;
      loadScenario();
    }

    startTicker();
  </script>
</body>
</html>
