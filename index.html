<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlackFog TTX – Facilitator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      /* New Color Palette */
      --color-bg-primary: #090e1a;
      --color-bg-secondary: #151b2a;
      --color-border: #2b3a50;
      --color-text-primary: #e5e7eb;
      --color-text-secondary: #94a3b8;
      --color-accent-blue: #3b82f6;
      --color-accent-green: #10b981;
      --color-accent-danger: #ef4444;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      line-height: 1.6;
    }
    header {
      padding: 1rem 1.5rem;
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.125rem;
      letter-spacing: .1em;
      text-transform: uppercase;
    }
    header .session {
      font-size: 0.75rem;
      opacity: 0.8;
      color: var(--color-text-secondary);
    }
    main {
      flex: 1;
      padding: 1.5rem 1.25rem;
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 1.5rem;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--color-bg-secondary);
      border-radius: 10px;
      border: 1px solid var(--color-border);
      padding: 1.25rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    .card h2 {
      margin: 0 0 0.75rem 0;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--color-text-secondary);
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 0.5rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    label {
      font-size: 0.8125rem;
      opacity: 0.85;
      color: var(--color-text-secondary);
    }
    input[type="text"], textarea, select {
      font-family: inherit;
      font-size: 0.875rem;
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      border-radius: 6px;
      border: 1px solid var(--color-border);
      padding: 0.4rem 0.6rem;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--color-accent-blue);
    }
    input[type="text"] { min-width: 120px; }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 70px;
      line-height: 1.5;
    }
    button {
      border-radius: 6px;
      border: none;
      padding: 0.4rem 0.75rem;
      font-size: 0.8125rem;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, opacity 0.2s;
    }
    button.primary { background: var(--color-accent-blue); color: #fff; }
    button.primary:hover:not(:disabled) { background: #60a5fa; }
    button.secondary { background: var(--color-border); color: var(--color-text-primary); }
    button.secondary:hover:not(:disabled) { background: #475569; }
    button.danger { background: var(--color-accent-danger); color: #fff; }
    button.danger:hover:not(:disabled) { background: #f87171; }
    button:disabled { opacity: .5; cursor: default; }
    .meta {
      font-size: 0.75rem;
      opacity: 0.85;
      margin-top: 0.5rem;
      white-space: pre-wrap;
      color: var(--color-text-secondary);
    }
    .scenario-text {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 0.75rem;
      white-space: pre-wrap;
      padding: 0.75rem;
      border-radius: 6px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
    }
    .inject-list {
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px dashed var(--color-border);
      margin-top: 0.75rem;
      padding-top: 0.5rem;
    }
    .inject-item {
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.7rem;
      border-radius: 6px;
      margin-bottom: 0.4rem;
      background: var(--color-bg-primary);
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.2s;
    }
    .inject-item:hover {
        background: #1e2536;
    }
    .inject-item.current {
      border: 1px solid var(--color-accent-blue);
      background: rgba(59, 130, 246, 0.1); /* Subtle blue background for current */
      font-weight: 600;
    }
    .pill {
      font-size: 0.6875rem;
      border-radius: 999px;
      padding: 2px 8px;
      background: #1f2937;
      margin-left: 6px;
      color: var(--color-text-secondary);
    }
    .current-inject {
      white-space: pre-wrap;
      font-size: 0.9375rem;
      line-height: 1.5;
      padding: 0.75rem;
      border-radius: 6px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
    }
    .votes {
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .badge {
      display: inline-block;
      min-width: 22px;
      text-align: center;
      border-radius: 4px;
      padding: 2px 6px;
      background: var(--color-bg-primary);
      margin-right: 8px;
      border: 1px solid var(--color-border);
    }
    .majority-label {
      font-size: 0.8125rem;
      opacity: 0.9;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--color-border);
    }
    .players {
      font-size: 0.875rem;
      max-height: 130px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #aarBox {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.6875rem;
      width: 100%;
      min-height: 90px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
      color: #cbd5e1;
    }
    footer {
      padding: 0.6rem 1.5rem 0.9rem;
      border-top: 1px solid var(--color-border);
      background: var(--color-bg-secondary);
      font-size: 0.6875rem;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }
    #ticker {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.9;
      color: var(--color-text-secondary);
    }
    #footerHint { opacity: 0.7; }
  </style>
</head>
<body>
<header>
  <h1>BLACKFOG TTX – FACILITATOR</h1>
  <div class="session">
    Session: <span id="sessionLabel"></span> · Players: <span id="playerCount"></span>
  </div>
</header>

<main>
  <section>
    <div class="card">
      <h2>Scenario</h2>
      <div class="row">
        <label for="scenarioTemplateSelect">Template</label>
        <select id="scenarioTemplateSelect">
          <option value="shaiHulud">Scenario 1 – Shai-Hulud 2.0 Supply Chain</option>
          <option value="apiAbuse">Scenario 2 – Stolen API Keys & Multi-Actor Abuse</option>
          <option value="lbCompromise">Scenario 3 – Load Balancer Compromise</option>
        </select>
      </div>
      <div class="row">
        <label for="scenarioTitle">Title</label>
        <input type="text" id="scenarioTitle">
        <button class="secondary" id="loadScenarioBtn">Load selected template</button>
      </div>
      <div class="row">
        <textarea id="scenarioDescription" placeholder="Scenario summary..."></textarea>
      </div>
      <div class="row">
        <button class="secondary" id="saveScenarioBtn">Save / update scenario text</button>
        <button class="primary" id="startSessionBtn">Start exercise</button>
        <button class="secondary" id="endSessionBtn">End session</button>
        <button class="danger" id="resetSessionBtn">Reset session</button>
      </div>
      <div id="scenarioText" class="scenario-text"></div>
      <div id="runStatus" class="meta">No scenario loaded yet.</div>
    </div>

    <div class="card">
      <h2>Injects</h2>
      <div class="row">
        <label for="injectTime">Time</label>
        <input type="text" id="injectTime" placeholder="T+00m" style="min-width: 80px;">
        <label for="injectPhase">Phase</label>
        <input type="text" id="injectPhase" placeholder="Intel / Detection / Containment..." style="min-width: 140px;">
        <label for="injectSeverity">Severity</label>
        <input type="text" id="injectSeverity" placeholder="Medium / High / Critical" style="min-width: 140px;">
      </div>
      <div class="row">
        <textarea id="injectNarrative" placeholder="Narrative..."></textarea>
      </div>
      <div class="row" style="margin-top: 12px;">
        <input type="text" id="decisionQuestion" placeholder="Decision question (optional)" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optA" placeholder="Option A" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optB" placeholder="Option B" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optC" placeholder="Option C" style="flex:1;">
      </div>
      <div class="row">
        <button class="secondary" id="updateInjectBtn">Save changes to selected inject</button>
        <button class="primary" id="sendNextBtn" disabled>Send next inject</button>
      </div>
      <div id="injectList" class="inject-list"></div>
    </div>

    <div class="card">
      <h2>Current Inject</h2>
      <div id="currentInjectBox" class="current-inject">No inject sent yet.</div>
    </div>
  </section>

  <section>
    <div class="card">
      <h2>Votes</h2>
      <div id="votesBox" class="votes">No votes yet.</div>
    </div>

    <div class="card">
      <h2>Players</h2>
      <div id="playersBox" class="players">Waiting for players…</div>
    </div>

    <div class="card">
      <h2>AAR</h2>
      <textarea id="aarBox" readonly>Click "Build AAR" after running through the injects.</textarea>
      <div class="row" style="margin-top:6px;">
        <button class="secondary" id="buildAarBtn">Build AAR</button>
        <button class="secondary" id="broadcastAarBtn">Broadcast AAR</button>
      </div>
    </div>
  </section>
</main>

<footer>
  <div id="ticker">Ready. Click "Load template" to push scenario + injects to this session.</div>
  <div id="footerHint">Players join via <code>player.html?s=&lt;session_id&gt;</code></div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getDatabase, ref, set, update, onValue, remove
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // Your existing Firebase project
  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  // ONE hardcoded scenario + inject pack (you can add more later)
  const templateScenarios = {
  "shaiHulud": {
    "title": "Shai-Hulud 2.0 \u2013 Supply Chain Attack",
    "description": "RWS is impacted by a sophisticated supply chain attack against Python packages on PyPI, where trojanised dependencies steal credentials and exfiltrate cloud and source code secrets.",
    "injects": [
      {
        "seq": 1,
        "time": "T+00m",
        "phase": "Intel",
        "severity": "Medium",
        "narrative": "RWS developers report that a CI/CD pipeline job exited with warnings about a dependency mismatch for a Python package used by several internal services. Security researchers publicly disclose that a trojanised version of the same package has appeared on PyPI, containing credential-stealing malware.",
        "decision": {
          "question": "How should RWS respond to the initial intelligence?",
          "options": {
            "A": "Immediately disable CI/CD pipelines using the affected package and begin threat hunting.",
            "B": "Continue operations normally while waiting for PyPI to provide more information.",
            "C": "Ask developers to manually review logs but take no wider action yet."
          }
        }
      },
      {
        "seq": 2,
        "time": "T+20m",
        "phase": "Detection",
        "severity": "High",
        "narrative": "Multiple CI runners begin making outbound network requests to an unfamiliar domain hosted on a foreign VPS provider. Traffic analysis shows bursts of encoded data being exfiltrated, and internal telemetry suggests that AWS temporary tokens may have been compromised.",
        "decision": {
          "question": "What is the appropriate detection-stage response?",
          "options": {
            "A": "Treat the event as active credential theft and escalate to a major incident.",
            "B": "Place monitoring alerts and observe for another 30 minutes.",
            "C": "Ask DevOps to rotate credentials next business day."
          }
        }
      },
      {
        "seq": 3,
        "time": "T+40m",
        "phase": "Containment",
        "severity": "Critical",
        "narrative": "CloudTrail logs show API calls being made with valid but unexpected AWS IAM tokens. The calls enumerate S3 buckets, EKS clusters and Secrets Manager. Some originate from IPs in multiple geographies, suggesting the attacker is using the trojan payload to pivot into cloud infrastructure.",
        "decision": {
          "question": "How should containment be executed?",
          "options": {
            "A": "Immediately revoke all AWS IAM tokens and rotate secrets across all environments.",
            "B": "Revoke only the developer IAM token that first triggered alerts.",
            "C": "Delay major changes until cloud forensics completes a full analysis."
          }
        }
      },
      {
        "seq": 4,
        "time": "T+1h10m",
        "phase": "Eradication",
        "severity": "High",
        "narrative": "A review reveals that several builds in the last 48 hours pulled the malicious package. Containers deployed to staging may contain the trojan, and build artifacts cannot be trusted. Developers raise concerns that automated scanning tools did not detect the tampering.",
        "decision": {
          "question": "What eradication strategy is appropriate?",
          "options": {
            "A": "Purge all potentially affected artifacts and rebuild from clean, verified packages.",
            "B": "Only rebuild the services showing suspicious network activity.",
            "C": "Continue using deployed containers while preparing a longer-term cleanup plan."
          }
        }
      },
      {
        "seq": 5,
        "time": "T+2h",
        "phase": "Recovery",
        "severity": "Medium",
        "narrative": "Freezing CI/CD pipelines causes delays in hotel, booking, loyalty and payments-related deployments. Business stakeholders demand clarity on when systems will resume normal deployment operations, and some teams request urgent hotfixes.",
        "decision": {
          "question": "How should leadership balance security recovery and business needs?",
          "options": {
            "A": "Maintain the freeze until full environment integrity is assured.",
            "B": "Allow deployments from an agreed set of critical teams under strict controls.",
            "C": "Lift the freeze entirely and rely on manual monitoring."
          }
        }
      },
      {
        "seq": 6,
        "time": "T+4h",
        "phase": "Communications",
        "severity": "High",
        "narrative": "Cybersecurity vendors and media outlets start reporting on Shai-Hulud 2.0 globally. RWS receives requests from partners seeking confirmation of exposure due to shared dependencies, and there is concern about regulatory obligations if API keys or customer data were compromised.",
        "decision": {
          "question": "What communication strategy is best for external stakeholders and regulators?",
          "options": {
            "A": "Proactively inform all partners and publish a public statement outlining remediation.",
            "B": "Delay all external communication until full internal investigation is complete.",
            "C": "Communicate only with regulators and partners who directly ask."
          }
        }
      }
    ]
  },
  "apiAbuse": { "title": "Scenario 2 – Stolen API Keys & Multi-Actor Abuse", "description": "Compromised API keys are used by multiple malicious actors to perform data exfiltration and inject malicious code into client-side assets.", "injects": [] },
  "lbCompromise": { "title": "Scenario 3 – Load Balancer Compromise", "description": "Attackers exploit a vulnerability in a legacy Load Balancer to gain network persistence and redirect traffic to a phishing site.", "injects": [] }
  };

  const params = new URLSearchParams(location.search);
  const sessionId = params.get("s") || "default";

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Database References
  const sessionRef    = ref(db, "sessions/" + sessionId);
  const scenarioRef   = ref(db, "sessions/" + sessionId + "/scenario");
  const injectsRef    = ref(db, "sessions/" + sessionId + "/injects");
  const latestInjectRef = ref(db, "sessions/" + sessionId + "/latestInject");
  const votesRef      = ref(db, "sessions/" + sessionId + "/votes");
  const playersRef    = ref(db, "sessions/" + sessionId + "/players");
  const aarRef        = ref(db, "sessions/" + sessionId + "/aar");

  // --- DOM Elements ---
  const sessionLabel = document.getElementById("sessionLabel");
  const playerCountEl = document.getElementById("playerCount");
  const scenarioTemplateSelect = document.getElementById("scenarioTemplateSelect");
  const scenarioTitle = document.getElementById("scenarioTitle");
  const scenarioDescription = document.getElementById("scenarioDescription");
  const loadScenarioBtn = document.getElementById("loadScenarioBtn");
  const saveScenarioBtn = document.getElementById("saveScenarioBtn");
  const startSessionBtn = document.getElementById("startSessionBtn");
  const endSessionBtn = document.getElementById("endSessionBtn");
  const resetSessionBtn = document.getElementById("resetSessionBtn");
  const scenarioText = document.getElementById("scenarioText");
  const runStatus = document.getElementById("runStatus");
  const injectTime = document.getElementById("injectTime");
  const injectPhase = document.getElementById("injectPhase");
  const injectSeverity = document.getElementById("injectSeverity");
  const injectNarrative = document.getElementById("injectNarrative");
  const decisionQuestion = document.getElementById("decisionQuestion");
  const optA = document.getElementById("optA");
  const optB = document.getElementById("optB");
  const optC = document.getElementById("optC");
  const updateInjectBtn = document.getElementById("updateInjectBtn");
  const sendNextBtn = document.getElementById("sendNextBtn");
  const injectListEl = document.getElementById("injectList");
  const currentInjectBox = document.getElementById("currentInjectBox");
  const votesBox = document.getElementById("votesBox");
  const playersBox = document.getElementById("playersBox");
  const aarBox = document.getElementById("aarBox");
  const buildAarBtn = document.getElementById("buildAarBtn");
  const broadcastAarBtn = document.getElementById("broadcastAarBtn");
  const tickerEl = document.getElementById("ticker");

  // --- Local State ---
  let allInjects = [];
  let currentScenario = { title: "", description: "", status: "idle" };
  let selectedInjectIndex = -1;
  let currentInject = null;
  let totalPlayers = 0;

  // --- Initial Setup ---
  sessionLabel.textContent = sessionId;
  playerCountEl.textContent = "0";

  // --- Functions ---
  function renderScenario() {
    scenarioText.textContent = `${currentScenario.title}\n\n${currentScenario.description}`;
    scenarioTitle.value = currentScenario.title;
    scenarioDescription.value = currentScenario.description;
    runStatus.textContent = `Status: ${currentScenario.status.toUpperCase()}`;
    sendNextBtn.disabled = currentScenario.status !== 'started' || selectedInjectIndex < 0;
  }

  function renderInjectList() {
    injectListEl.innerHTML = "";
    allInjects.forEach((inj, index) => {
      const item = document.createElement("div");
      item.className = "inject-item" + (index === selectedInjectIndex ? " current" : "");
      item.innerHTML = `
        ${inj.seq}. ${inj.phase} <span class="pill">${inj.time}</span>
        <button data-index="${index}" class="secondary select-inject-btn" style="padding: 2px 6px;">Edit</button>
      `;
      item.querySelector(".select-inject-btn").onclick = (e) => {
        e.stopPropagation();
        selectInject(index);
      };
      injectListEl.appendChild(item);
    });
    sendNextBtn.disabled = currentScenario.status !== 'started' || selectedInjectIndex < 0;
  }

  function selectInject(index) {
    selectedInjectIndex = index;
    const inj = allInjects[index];
    if (inj) {
      injectTime.value = inj.time || "";
      injectPhase.value = inj.phase || "";
      injectSeverity.value = inj.severity || "";
      injectNarrative.value = inj.narrative || "";
      decisionQuestion.value = inj.decision?.question || "";
      optA.value = inj.decision?.options?.A || "";
      optB.value = inj.decision?.options?.B || "";
      optC.value = inj.decision?.options?.C || "";
      updateInjectBtn.textContent = "Save changes to inject " + inj.seq;
      renderInjectList();
      currentInject = inj;
      // Also update the current inject display, even if not officially sent
      currentInjectBox.textContent = `Inject #${inj.seq} (${inj.phase} - ${inj.time}):\n\n${inj.narrative}\n\nDecision: ${inj.decision?.question || "None"}`;
    }
  }

  function resetInjectForm() {
    selectedInjectIndex = -1;
    injectTime.value = "";
    injectPhase.value = "";
    injectSeverity.value = "";
    injectNarrative.value = "";
    decisionQuestion.value = "";
    optA.value = "";
    optB.value = "";
    optC.value = "";
    updateInjectBtn.textContent = "Save changes to selected inject";
    renderInjectList();
  }

  // --- Firebase Event Handlers (Listeners) ---

  // Listen for Scenario updates
  onValue(scenarioRef, snap => {
    const sc = snap.val();
    if (sc) {
      // FIX 1 (from previous step): Ensure status has a default value if missing from the snapshot
      currentScenario = {
          title: sc.title || "",
          description: sc.description || "",
          status: sc.status || "idle"
      };
      renderScenario();
    } else {
      currentScenario = { title: "", description: "", status: "idle" };
      renderScenario();
    }
  });

  // Listen for Inject List updates
  onValue(injectsRef, snap => {
    const injList = snap.val();
    allInjects = injList ? Object.values(injList) :