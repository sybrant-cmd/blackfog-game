<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlackFog TTX - Facilitator</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 2fr 1.7fr;
      gap: 16px;
      padding: 16px 20px 20px;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .04em;
      color: #9ca3af;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    select, button, textarea {
      font-family: inherit;
      font-size: 13px;
    }
    select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 4px 6px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #374151;
      color: #e5e7eb;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .scenario-desc {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }
    .inject-list {
      max-height: 220px;
      overflow-y: auto;
      padding-top: 4px;
      border-top: 1px dashed #111827;
    }
    .inject-item {
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .inject-item:hover {
      background: #111827;
    }
    .inject-item.active {
      background: #1d4ed8;
    }
    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 6px;
      background: #111827;
      margin-left: 4px;
    }
    .current-inject {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.4;
    }
    .votes {
      font-size: 12px;
      line-height: 1.4;
    }
    .badge {
      display: inline-block;
      min-width: 22px;
      text-align: center;
      border-radius: 999px;
      padding: 2px 6px;
      background: #111827;
      margin-right: 4px;
    }
    .vciso {
      font-size: 12px;
      font-style: italic;
      opacity: 0.9;
      margin-top: 4px;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 8px;
    }
    .players {
      font-size: 12px;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    footer {
      font-size: 11px;
      opacity: 0.6;
      padding: 4px 20px 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>BlackFog TTX — Facilitator</h1>
    <div style="font-size:11px;opacity:.7;">Session: <span id="sessionIdLabel"></span></div>
  </header>
  <main>
    <section>
      <div class="card">
        <h2>Scenario &amp; Injects</h2>
        <div class="row">
          <label for="scenarioSelect" style="font-size:12px;">Scenario:</label>
          <select id="scenarioSelect"></select>
          <button class="primary" id="loadScenarioBtn">Load</button>
        </div>
        <div id="scenarioDesc" class="scenario-desc"></div>
        <div class="row">
          <button class="primary" id="sendNextBtn">Send next inject</button>
          <button class="secondary" id="buildAARBtn">Build AAR &amp; broadcast</button>
        </div>
        <div id="injectList" class="inject-list"></div>
      </div>
      <div class="card">
        <h2>Current Inject</h2>
        <div id="currentInjectBox" class="current-inject">No inject sent yet.</div>
      </div>
    </section>
    <section>
      <div class="card">
        <h2>Votes &amp; vCISO</h2>
        <div id="votesBox" class="votes">No votes yet.</div>
        <div id="vcisoBox" class="vciso"></div>
      </div>
      <div class="card">
        <h2>Connected Players</h2>
        <div id="playersBox" class="players">Waiting for players…</div>
      </div>
      <div class="card">
        <h2>AAR Preview</h2>
        <textarea id="aarBox" readonly>Click “Build AAR & broadcast” after the run.</textarea>
      </div>
    </section>
  </main>
  <footer>
    Open <code>player.html?s=&lt;session_id&gt;</code> in other browsers/windows for participants.
  </footer>

  <script type="module">
    import {
      sessionId,
      channel,
      listScenarios,
      getScenario,
      initVoteLog,
      registerVote,
      getTallyFor,
      buildAAR,
      buildVCISOInjectComment
    } from './engine.mjs';

    const sessionIdLabel = document.getElementById('sessionIdLabel');
    const scenarioSelect = document.getElementById('scenarioSelect');
    const loadScenarioBtn = document.getElementById('loadScenarioBtn');
    const sendNextBtn = document.getElementById('sendNextBtn');
    const buildAARBtn = document.getElementById('buildAARBtn');
    const scenarioDesc = document.getElementById('scenarioDesc');
    const injectList = document.getElementById('injectList');
    const currentInjectBox = document.getElementById('currentInjectBox');
    const votesBox = document.getElementById('votesBox');
    const vcisoBox = document.getElementById('vcisoBox');
    const playersBox = document.getElementById('playersBox');
    const aarBox = document.getElementById('aarBox');

    sessionIdLabel.textContent = sessionId;

    let currentScenarioId = null;
    let currentInjectIndex = -1;
    let voteLog = initVoteLog();
    const players = new Map(); // playerId -> lastSeen

    // Populate scenarios
    for (const s of listScenarios()) {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.title;
      scenarioSelect.appendChild(opt);
    }

    function renderScenarioDesc() {
      const sc = getScenario(currentScenarioId);
      scenarioDesc.textContent = sc ? sc.description : '';
    }

    function renderInjectList() {
      injectList.innerHTML = '';
      const sc = getScenario(currentScenarioId);
      if (!sc) return;
      sc.injects.forEach((inj, idx) => {
        const div = document.createElement('div');
        div.className = 'inject-item' + (idx === currentInjectIndex ? ' active' : '');
        const left = document.createElement('div');
        left.textContent = `#${inj.seq} ${inj.phase}`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="pill">${inj.time}</span>`;
        div.appendChild(left);
        div.appendChild(right);
        div.addEventListener('click', () => {
          currentInjectIndex = idx;
          sendInject();
        });
        injectList.appendChild(div);
      });
    }

    function renderCurrentInject(inj) {
      if (!inj) {
        currentInjectBox.textContent = 'No inject sent yet.';
        return;
      }
      const lines = [];
      lines.push(`${inj.time}  •  ${inj.phase}`);
      const cues = inj.cues || {};
      lines.push(`${cues.severity || ''} ${(cues.impact || []).join('  ')}  ${cues.phase || ''}`);
      lines.push('');
      lines.push(inj.narrative);
      if (inj.decision) {
        lines.push('');
        lines.push('Decision: ' + inj.decision.question);
        for (const [k, v] of Object.entries(inj.decision.options || {})) {
          lines.push(`  ${k}. ${v}`);
        }
      }
      currentInjectBox.textContent = lines.join('\n');
    }

    function renderVotes(inj) {
      if (!inj) {
        votesBox.textContent = 'No votes yet.';
        vcisoBox.textContent = '';
        return;
      }
      const tally = getTallyFor(voteLog, currentScenarioId, inj.seq);
      votesBox.innerHTML =
        `<div><span class="badge">A</span> ${tally.A}</div>` +
        `<div><span class="badge">B</span> ${tally.B}</div>` +
        `<div><span class="badge">C</span> ${tally.C}</div>`;
      const vc = buildVCISOInjectComment(inj, tally);
      vcisoBox.textContent = vc ? 'vCISO: ' + vc : '';
    }

    function renderPlayers() {
      if (players.size === 0) {
        playersBox.textContent = 'Waiting for players…';
        return;
      }
      const now = Date.now();
      const lines = [];
      for (const [id, ts] of players.entries()) {
        const age = Math.round((now - ts) / 1000);
        lines.push(`${id}  (last seen ${age}s ago)`);
      }
      playersBox.textContent = lines.join('\n');
    }

    function loadScenario() {
      const id = scenarioSelect.value;
      if (!id) return;
      currentScenarioId = id;
      currentInjectIndex = -1;
      voteLog = initVoteLog();
      renderScenarioDesc();
      renderInjectList();
      currentInjectBox.textContent = 'Scenario loaded. Click “Send next inject” to begin.';
      votesBox.textContent = 'No votes yet.';
      vcisoBox.textContent = '';
      aarBox.value = 'Click “Build AAR & broadcast” after the run.';

      channel.postMessage({
        session: sessionId,
        type: 'scenarioLoaded',
        scenarioId: currentScenarioId
      });
    }

    function sendInject() {
      const sc = getScenario(currentScenarioId);
      if (!sc) return;
      if (currentInjectIndex < 0 || currentInjectIndex >= sc.injects.length) return;
      const inj = sc.injects[currentInjectIndex];
      renderInjectList();
      renderCurrentInject(inj);
      renderVotes(inj);

      channel.postMessage({
        session: sessionId,
        type: 'inject',
        scenarioId: currentScenarioId,
        injectSeq: inj.seq,
        inject
      });
    }

    function sendNextInject() {
      const sc = getScenario(currentScenarioId);
      if (!sc) return;
      if (currentInjectIndex + 1 >= sc.injects.length) return;
      currentInjectIndex += 1;
      sendInject();
    }

    function doBuildAAR() {
      if (!currentScenarioId) return;
      const text = buildAAR(currentScenarioId, voteLog);
      aarBox.value = text || 'No AAR data.';
      channel.postMessage({
        session: sessionId,
        type: 'aar',
        scenarioId: currentScenarioId,
        aarText: aarBox.value
      });
    }

    loadScenarioBtn.addEventListener('click', loadScenario);
    sendNextBtn.addEventListener('click', sendNextInject);
    buildAARBtn.addEventListener('click', doBuildAAR);

    channel.onmessage = ev => {
      const msg = ev.data;
      if (!msg || msg.session !== sessionId) return;
      if (msg.type === 'join' || msg.type === 'ping') {
        players.set(msg.playerId, Date.now());
        // prune old
        const now = Date.now();
        for (const [id, ts] of players.entries()) {
          if (now - ts > 20000) {
            players.delete(id);
          }
        }
        renderPlayers();
      } else if (msg.type === 'vote') {
        if (!currentScenarioId || msg.scenarioId !== currentScenarioId) return;
        registerVote(voteLog, msg.scenarioId, msg.injectSeq, msg.choice, msg.playerId);
        const sc = getScenario(currentScenarioId);
        const inj = sc.injects.find(i => i.seq === msg.injectSeq);
        if (inj) renderVotes(inj);
      }
    };

    // autoload first scenario if available
    if (scenarioSelect.options.length > 0) {
      scenarioSelect.selectedIndex = 0;
      loadScenario();
    }
  </script>
</body>
</html>
