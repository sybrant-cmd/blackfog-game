<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RWS BlackFog â€“ Facilitator v4.12</title>
<meta name="theme-color" content="#00BFA5" />
<style>
:root {
  --teal: #00BFA5;
  --gold: #D4AF37;
  --navy: #020617;
  --bg2: #050814;
  --panel: #0b1220cc;
  --stroke: rgba(255,255,255,0.09);
  --text: #E5E7EB;
  --muted: #9CA3AF;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  color: var(--text);
  background: radial-gradient(circle at top, #111827 0, #020617 60%);
}
header {
  position: sticky;
  top: 0; z-index: 20;
  padding: 10px 18px;
  border-bottom: 1px solid var(--stroke);
  background: linear-gradient(180deg, rgba(0,0,0,0.96), rgba(15,23,42,0.88));
  backdrop-filter: blur(12px);
  display:flex; align-items:center; justify-content:space-between;
}
.brand { display:flex; align-items:center; gap:10px; }
.brand-dot {
  width: 14px; height: 14px;
  border-radius: 50%;
  background: var(--teal);
  box-shadow: 0 0 16px rgba(45,212,191,0.9);
}
h1 { margin: 0; font-size: 18px; }
.badges { display:flex; gap:8px; flex-wrap:wrap; }
.badge {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: rgba(15,23,42,0.9);
}
.container { max-width: 1200px; margin: 0 auto; padding: 14px 16px 40px; }
.grid { display:grid; grid-template-columns: 2fr 1fr; gap:16px; align-items:flex-start; }
.card {
  background: var(--panel);
  border-radius: 16px;
  border: 1px solid var(--stroke);
  box-shadow: 0 18px 50px rgba(0,0,0,0.65);
  padding: 14px 14px 12px;
}
.card-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
.card-header h2 { margin:0; font-size:15px; }
.card-body { font-size:13px; }
label { display:block; font-size:12px; color:var(--muted); margin-bottom:2px; }
input, textarea, select {
  width:100%;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--stroke);
  background:#020617;
  color:var(--text);
  font-family:inherit;
  font-size:13px;
}
textarea { min-height:60px; resize:vertical; }
.row { display:flex; gap:8px; }
.row-right { justify-content:flex-end; }
.btn {
  border-radius:999px;
  border:1px solid var(--stroke);
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  background:#020617;
  color:var(--text);
}
.btn-primary { background:var(--teal); border-color:var(--teal); color:#022c22; font-weight:600; }
.btn-ghost { background:transparent; }
.btn-danger { background:#b91c1c; border-color:#fecaca; color:#fee2e2; }
.btn:hover { filter:brightness(1.05); }
.timeline { display:flex; flex-direction:column; gap:8px; max-height:360px; overflow-y:auto; margin-top:8px; }
.inj {
  display:grid;
  grid-template-columns: 70px 120px 1fr auto;
  gap:10px;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--stroke);
  background:rgba(15,23,42,0.9);
}
.inj-time { font-weight:700; color:var(--gold); font-size:12px; }
.inj-type { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--stroke); display:inline-flex; align-items:center; gap:4px; }
.inj-type-Intel { background: rgba(34,197,94,0.08); }
.inj-type-Detection { background: rgba(248,113,113,0.15); }
.inj-type-Containment { background: rgba(59,130,246,0.15); }
.inj-type-Comms { background: rgba(234,179,8,0.15); }
.inj-type-Recovery { background: rgba(52,211,153,0.12); }
.inj-meta { font-size:11px; color:var(--muted); margin-top:4px; }
.inj-text { font-size:13px; color:#e5e7eb; }
#log { max-height:220px; overflow-y:auto; font-family:ui-monospace,monospace; font-size:11px; background:#020617; border-radius:8px; padding:6px 8px; border:1px solid rgba(15,23,42,0.9); }
.log-line { padding:1px 0; }
.aar-table { width:100%; border-collapse:collapse; margin-top:8px; font-size:12px; }
.aar-table th, .aar-table td { border:1px solid rgba(148,163,184,0.5); padding:4px 6px; }
.aar-table th { background:#020617; }
.player-row { display:flex; justify-content:space-between; font-size:12px; padding:4px 0; border-bottom:1px dashed rgba(148,163,184,0.3); }
.footer { margin-top:10px; font-size:11px; color:var(--muted); text-align:center; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-dot"></div>
    <h1>RWS BlackFog â€“ Facilitator v4.12</h1>
  </div>
  <div class="badges">
    <div class="badge">Session: <strong id="sessionId">default</strong></div>
    <div class="badge">Players: <strong id="playersCount">0</strong></div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div>
      <!--
        RWS Cyber Range â€“ Scenario configuration block.
        Facilitator uses this to define high-level narrative shared with all players.
      -->
      <section class="card">
        <div class="card-header">
          <h2>Scenario Setup</h2>
          <div class="row">
            <button id="btnPreset" class="btn-ghost">ðŸ“¦ Load Preset</button>
            <button id="btnPublishScenario" class="btn-primary">ðŸ“¡ Publish to players</button>
          </div>
        </div>
        <div class="card-body">
          <label>Scenario title</label>
          <input id="scTitle" placeholder="e.g. Operation BlackFog â€“ Supply Chain to APT (RWS)" />
          <label style="margin-top:4px;">Scenario description</label>
          <textarea id="scDesc" placeholder="High-level narrative for execs and participants."></textarea>
        </div>
      </section>

      <!--
        RWS Cyber Range â€“ Inject builder.
        Facilitator creates each inject, optionally with a decision (A/B/C).
        Injects are *local* until they are sent using the ðŸš€ button.
      -->
      <section class="card" style="margin-top:14px;">
        <div class="card-header">
          <h2>Inject Builder</h2>
          <span style="font-size:11px; color:var(--muted);">Craft injects and attach optional decisions</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div style="flex:0 0 90px;">
              <label>T+ time</label>
              <input id="injTime" placeholder="e.g. T+5m" />
            </div>
            <div style="flex:0 0 130px;">
              <label>Type</label>
              <select id="injType">
                <option>Intel</option>
                <option>Detection</option>
                <option>Containment</option>
                <option>Comms</option>
                <option>Recovery</option>
              </select>
            </div>
          </div>
          <label style="margin-top:6px;">Inject text</label>
          <textarea id="injText" placeholder="What is happening? What do players see?"></textarea>

          <div style="margin-top:8px;">
            <label>Decision question (optional)</label>
            <input id="decQuestion" placeholder="e.g. Should RWS isolate all PayGateX POS systems immediately?" />
            <div class="row" style="margin-top:4px;">
              <div style="flex:1;">
                <label>Option A</label>
                <input id="decA" placeholder="e.g. Yes â€“ isolate all affected POS endpoints now." />
              </div>
              <div style="flex:1;">
                <label>Option B</label>
                <input id="decB" placeholder="e.g. Delay isolation until business validation." />
              </div>
            </div>
            <div style="margin-top:4px;">
              <label>Option C</label>
              <input id="decC" placeholder="e.g. Monitor and collect more telemetry first." />
            </div>
          </div>

          <div class="row row-right" style="margin-top:8px;">
            <button class="btn-ghost" id="btnAddInject">âž• Add to timeline</button>
          </div>

          <!-- Timeline shows local list of injects in this run -->
          <div class="timeline" id="timeline"></div>
        </div>
      </section>

      <!--
        RWS Cyber Range â€“ Control & After-Action Report (AAR).
        Log: facilitator actions.
        AAR: summary of decisions (A/B/C distribution per inject).
      -->
      <section class="card" style="margin-top:14px;">
        <div class="card-header">
          <h2>Control & AAR</h2>
        </div>
        <div class="card-body">
          <div id="log"></div>
          <div class="row" style="margin-top:8px;">
            <button id="btnEnd" class="btn-danger">ðŸ›‘ End Simulation & Build AAR</button>
            <button id="btnRestart" class="btn-ghost">ðŸ”„ Hard Reset Session</button>
            <button id="btnExportAAR" class="btn-ghost">ðŸ“„ Open AAR in new tab</button>
          </div>
          <div id="aar" style="margin-top:10px; display:none;">
            <h3 style="margin:0 0 6px 0; font-size:13px;">Decision Summary (this session)</h3>
            <table class="aar-table">
              <thead><tr><th>Inject</th><th>A</th><th>B</th><th>C</th></tr></thead>
              <tbody id="aarBody"></tbody>
            </table>
          </div>
        </div>
      </section>
      <div class="footer">
        RWS Cyber Crisis Range Â· Facilitator Console v4.12
      </div>
    </div>

    <!-- Right-hand rail shows live connected players -->
    <aside>
      <section class="card">
        <div class="card-header"><h2>Connected Players</h2></div>
        <div class="card-body" id="players" style="min-height:120px; font-size:12px;"></div>
      </section>
    </aside>
  </div>
</div>

<script type="module">
/*
  RWS BlackFog â€“ Facilitator Console Script
  -----------------------------------------
  Key responsibilities:
  - Initialise Firebase and point to the right session.
  - Let facilitator define scenario details.
  - Build an ordered inject timeline (local in browser).
  - Push individual injects live to players (latestInject + injects list).
  - Track player connections.
  - Build After-Action Report (AAR) from recorded votes.
*/

import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
import { getDatabase, ref, set, push, onValue, remove, get } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';

/* --- Firebase initialisation for RWS BlackFog project --- */
const firebaseConfig = {
  apiKey: 'AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0',
  authDomain: 'rws-blackfog-game.firebaseapp.com',
  databaseURL: 'https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app',
  projectId: 'rws-blackfog-game',
  storageBucket: 'rws-blackfog-game.firebasestorage.app',
  messagingSenderId: '473543964029',
  appId: '1:473543964029:web:4bc0db33634ed2f8894814'
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const $ = (id) => document.getElementById(id);

/*
  Session routing:
  - Facilitator can pass ?s=run-1 or ?s=table-b etc.
  - Default if not specified: "default".
  - Players must use the same session value to join the same exercise.
*/
const urlS = new URLSearchParams(location.search).get('s');
const session = urlS && urlS.trim() ? urlS.trim() : 'default';
$('sessionId').textContent = session;

/* --- Simple log helper: writes facilitator actions to on-screen console --- */
function log(msg) {
  const line = document.createElement('div');
  line.className = 'log-line';
  const t = new Date().toLocaleTimeString();
  line.textContent = '[' + t + '] ' + msg;
  $('log').prepend(line);
}

/* --- In-memory inject timeline for this browser --- */
let injects = [];
let injectSeq = 0;

/*
  Render the inject timeline on the left.
  This is purely a facilitator view; nothing here automatically
  pushes to players until ðŸš€ Send is clicked on a row.
*/
function renderTimeline() {
  const wrap = $('timeline');
  wrap.innerHTML = '';
  injects.forEach((inj) => {
    const row = document.createElement('div');
    row.className = 'inj';
    row.title = inj.decision && inj.decision.question ? inj.decision.question : (inj.text || '');

    const timeDiv = document.createElement('div');
    timeDiv.className = 'inj-time';
    timeDiv.textContent = inj.time || 'T+?m';

    const typeDiv = document.createElement('div');
    const typeClass = 'inj-type-' + (inj.type || 'Intel');
    const tag = document.createElement('div');
    tag.className = 'inj-type ' + typeClass;
    tag.textContent = inj.type || '';
    const meta = document.createElement('div');
    meta.className = 'inj-meta';
    const hasDecision = inj.decision && inj.decision.question;
    // impact is left empty for now â€“ can be used for scoring or severity notes
    meta.textContent = (inj.impact || '') + (hasDecision ? ' â€¢ Decision attached' : '');
    typeDiv.appendChild(tag);
    typeDiv.appendChild(meta);

    const textDiv = document.createElement('div');
    textDiv.className = 'inj-text';
    textDiv.textContent = inj.text || '';

    const btnDiv = document.createElement('div');
    const btn = document.createElement('button');
    btn.textContent = 'ðŸš€ Send';
    btn.className = 'btn btn-primary';
    // Clicking this publishes the inject live to all players in this session.
    btn.onclick = () => sendInject(inj);
    btnDiv.appendChild(btn);

    row.appendChild(timeDiv);
    row.appendChild(typeDiv);
    row.appendChild(textDiv);
    row.appendChild(btnDiv);
    wrap.appendChild(row);
  });
}

/*
  Push a single inject live to players.
  - latestInject: the current active inject (what the players see).
  - injects list: historical log of everything that was sent in this session.
*/
async function sendInject(inj) {
  const payload = Object.assign({ at: Date.now() }, inj);
  await set(ref(db, `sessions/${session}/latestInject`), payload);
  await push(ref(db, `sessions/${session}/injects`), payload);
  log(`Inject sent: ${inj.time} (${inj.type})`);
}

/*
  "Add to timeline" only updates the local browser.
  It does NOT send anything to players yet.
*/
$('btnAddInject').onclick = () => {
  const time = $('injTime').value || 'T+?m';
  const type = $('injType').value || 'Intel';
  const text = $('injText').value || '';
  const q = $('decQuestion').value.trim();
  const A = $('decA').value.trim();
  const B = $('decB').value.trim();
  const C = $('decC').value.trim();
  const decision = q ? { question: q, options: { A, B, C } } : null;
  const inj = {
    seq: ++injectSeq,
    time,
    type,
    text,
    impact: '',
    decision
  };
  injects.push(inj);
  renderTimeline();

  // Clear UI fields for next inject
  $('injText').value = '';
  $('decQuestion').value = '';
  $('decA').value = '';
  $('decB').value = '';
  $('decC').value = '';
};

/*
  Publish scenario to players:
  - Player UI will store this, but only show it when the FIRST inject arrives.
  - This avoids participants reading ahead while facilitator is still prepping.
*/
$('btnPublishScenario').onclick = async () => {
  const title = $('scTitle').value || 'RWS Cyber Crisis Scenario';
  const desc = $('scDesc').value || '';
  await set(ref(db, `sessions/${session}/scenario`), {
    title,
    desc,
    at: Date.now()
  });
  log('Scenario published to players (will appear for them once first inject is live).');
};

/*
  Preset: Opinionated RWS supply-chain â†’ APT storyline.
  This can be used as-is or edited by the facilitator before sending injects.
*/
$('btnPreset').onclick = () => {
  $('scTitle').value = 'Operation BlackFog â€“ Supply Chain Breach to APT (RWS)';
  $('scDesc').value = 'Compromised third-party payment gateway update propagates into RWS POS network, leading to lateral movement towards finance and loyalty systems.';

  injects = [
    {
      seq: 1,
      time: 'T+0m',
      type: 'Intel',
      text: 'Vendor PayGateX issues an emergency overnight update to all RWS POS terminals. Ops has been told it is â€œcritical for service continuityâ€.',
      decision: null
    },
    {
      seq: 2,
      time: 'T+5m',
      type: 'Detection',
      text: 'SOC detects unusual outbound traffic from the POS VLAN to an IP range in Eastern Europe, using ports normally not seen in payment flows.',
      decision: {
        question: 'Should RWS isolate all PayGateX POS systems immediately?',
        options: {
          A: 'Yes â€“ isolate all affected POS endpoints now.',
          B: 'Delay isolation until business validation approves the impact.',
          C: 'Monitor first and collect more telemetry before acting.'
        }
      }
    },
    {
      seq: 3,
      time: 'T+15m',
      type: 'Containment',
      text: 'EDR flags encoded PowerShell beacons on the PayGateX connector server. There are signs of attempted credential dumping on an adjacent jump host.',
      decision: {
        question: 'Do we escalate to external DFIR / MXDR partner now?',
        options: {
          A: 'Yes â€“ activate DFIR / MXDR and share indicators immediately.',
          B: 'Contain internally first and escalate only if signals worsen.',
          C: 'Hold until there is hard evidence of data exfiltration.'
        }
      }
    },
    {
      seq: 4,
      time: 'T+30m',
      type: 'Comms',
      text: 'Payment failures begin across several outlets. Floor staff report frustrated guests and the hashtag â€œRWS systems downâ€ begins to appear on social media.',
      decision: {
        question: 'How should RWS communicate this issue externally at this point?',
        options: {
          A: 'Issue a short holding statement acknowledging a technical issue and that teams are working on it.',
          B: 'Remain silent until full root cause is confirmed.',
          C: 'Publicly attribute the issue to the upstream vendor at this stage.'
        }
      }
    },
    {
      seq: 5,
      time: 'T+45m',
      type: 'Recovery',
      text: 'EDR blocks an exfiltration attempt from a server pivoting out of the finance segment. Partial exposure of guest data is suspected but not fully confirmed.',
      decision: {
        question: 'What is the next best move for RWS executives?',
        options: {
          A: 'Prepare regulatory notifications and a board brief now, based on â€œsuspectedâ€ exposure.',
          B: 'Focus only on technical clean-up first and delay regulatory engagement.',
          C: 'Assume no reportable breach until investigative teams confirm otherwise.'
        }
      }
    }
  ];

  injectSeq = injects.length;
  renderTimeline();
  log('Preset scenario loaded. Use ðŸš€ Send on each inject to drive the exercise.');
};

/*
  End simulation and build After-Action Report:
  - Reads all votes from sessions/{session}/votes
  - Aggregates A/B/C per inject sequence.
  - Renders a small table in the facilitator UI.
*/
$('btnEnd').onclick = async () => {
  if (!confirm('End simulation and build AAR from votes?')) return;
  const votesSnap = await get(ref(db, `sessions/${session}/votes`));
  const votes = votesSnap.val() || {};
  const byInject = {};

  Object.keys(votes).forEach(seq => {
    const perPlayer = votes[seq] || {};
    byInject[seq] = { A: 0, B: 0, C: 0 };
    Object.values(perPlayer).forEach(v => {
      if (v.choice && byInject[seq][v.choice] !== undefined) {
        byInject[seq][v.choice]++;
      }
    });
  });

  const tbody = $('aarBody');
  tbody.innerHTML = '';
  const rows = [];
  injects.forEach(inj => {
    const seq = String(inj.seq);
    const summary = byInject[seq] || { A: 0, B: 0, C: 0 };
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inj.time}</td><td>${summary.A}</td><td>${summary.B}</td><td>${summary.C}</td>`;
    tbody.appendChild(tr);
    rows.push({
      seq: inj.seq,
      time: inj.time,
      type: inj.type,
      text: inj.text,
      votes: summary
    });
  });
  $('aar').style.display = 'block';
  // Keep last AAR export data in window so facilitator can open it in a new tab.
  window.__rwsLastAAR = {
    session,
    scenario: {
      title: $('scTitle').value || 'RWS Cyber Crisis Scenario',
      desc: $('scDesc').value || ''
    },
    rows
  };
  log('AAR built from recorded votes.');
};

/*
  Export AAR to a separate browser tab as a simple HTML report.
  Facilitator can then save as PDF or copy into internal documentation.
*/
$('btnExportAAR').onclick = () => {
  const data = window.__rwsLastAAR;
  if (!data) { alert('No AAR data yet. End a simulation first.'); return; }
  const win = window.open('', '_blank', 'noopener');
  const doc = win.document;
  const rowsHtml = data.rows.map(r => (
    `<tr><td>${r.seq}</td><td>${r.time}</td><td>${r.type}</td><td>${r.text}</td><td>${r.votes.A}</td><td>${r.votes.B}</td><td>${r.votes.C}</td></tr>`
  )).join('');
  const html =
    '<!DOCTYPE html><html><head><meta charset="utf-8"><title>RWS BlackFog AAR â€“ ' + data.session + '</title>' +
    '<style>body{font-family:system-ui,sans-serif;background:#020617;color:#e5e7eb;margin:20px;}' +
    'h1,h2{margin:0 0 8px 0;} table{border-collapse:collapse;width:100%;margin-top:12px;}' +
    'th,td{border:1px solid #475569;padding:6px 8px;font-size:12px;} th{background:#111827;}' +
    '.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #fbbf24;color:#facc15;font-size:11px;}' +
    '</style></head><body>' +
    '<h1>RWS BlackFog â€“ After Action Report</h1>' +
    '<p><span class="pill">Session: ' + data.session + '</span></p>' +
    '<h2>' + data.scenario.title + '</h2>' +
    '<p>' + data.scenario.desc + '</p>' +
    '<table><thead><tr><th>#</th><th>Time</th><th>Type</th><th>Inject</th><th>A</th><th>B</th><th>C</th></tr></thead><tbody>' +
    rowsHtml +
    '</tbody></table>' +
    '<p style="margin-top:16px;font-size:12px;color:#9ca3af;">Generated from live BlackFog exercise data. Add your own narrative, lessons learned, and follow-up actions.</p>' +
    '</body></html>';
  doc.open(); doc.write(html); doc.close();
};

/*
  Hard reset for a session:
  - Wipes scenario, injects, votes and players *for this session* only.
  - Useful when reusing the same session code (e.g. "run-1") for multiple runs.
*/
$('btnRestart').onclick = async () => {
  if (!confirm('This will wipe the session (scenario, injects, votes, players). Proceed?')) return;
  await remove(ref(db, `sessions/${session}`));
  injects = [];
  injectSeq = 0;
  renderTimeline();
  $('scTitle').value = '';
  $('scDesc').value = '';
  $('aar').style.display = 'none';
  $('players').innerHTML = '';
  $('playersCount').textContent = '0';
  log('Session data cleared for session: ' + session);
};

/*
  Live players:
  - Listens on sessions/{session}/players for all connected player entries.
  - Player page sets/updates its own record and removes it on disconnect.
*/
onValue(ref(db, `sessions/${session}/players`), snap => {
  const val = snap.val() || {};
  const arr = Object.values(val);
  $('playersCount').textContent = String(arr.length);
  const host = $('players');
  host.innerHTML = '';
  if (!arr.length) {
    host.textContent = 'No players connected yet.';
    return;
  }
  arr.forEach(p => {
    const row = document.createElement('div');
    row.className = 'player-row';
    const last = p.lastSeen ? new Date(p.lastSeen).toLocaleTimeString() : '';
    row.innerHTML = `<span>ðŸŸ¢ ${p.name || p.id}</span><span>${last}</span>`;
    host.appendChild(row);
  });
});

log('Facilitator console ready. Configure scenario, use "âž• Add to timeline", then ðŸš€ Send to drive the exercise.');
</script>
</body>
</html>
