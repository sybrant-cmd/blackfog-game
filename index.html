<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlackFog TTX – Facilitator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      /* New Color Palette */
      --color-bg-primary: #090e1a;
      --color-bg-secondary: #151b2a;
      --color-border: #2b3a50;
      --color-text-primary: #e5e7eb;
      --color-text-secondary: #94a3b8;
      --color-accent-blue: #3b82f6;
      --color-accent-green: #10b981;
      --color-accent-danger: #ef4444;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      line-height: 1.6;
    }
    header {
      padding: 1rem 1.5rem;
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.125rem;
      letter-spacing: .1em;
      text-transform: uppercase;
    }
    header .session {
      font-size: 0.75rem;
      opacity: 0.8;
      color: var(--color-text-secondary);
    }
    main {
      flex: 1;
      padding: 1.5rem 1.25rem;
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 1.5rem;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--color-bg-secondary);
      border-radius: 10px;
      border: 1px solid var(--color-border);
      padding: 1.25rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    .card h2 {
      margin: 0 0 0.75rem 0;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--color-text-secondary);
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 0.5rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    label {
      font-size: 0.8125rem;
      opacity: 0.85;
      color: var(--color-text-secondary);
    }
    input[type="text"], textarea, select {
      font-family: inherit;
      font-size: 0.875rem;
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      border-radius: 6px;
      border: 1px solid var(--color-border);
      padding: 0.4rem 0.6rem;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--color-accent-blue);
    }
    input[type="text"] { min-width: 120px; }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 70px;
      line-height: 1.5;
    }
    button {
      border-radius: 6px;
      border: none;
      padding: 0.4rem 0.75rem;
      font-size: 0.8125rem;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, opacity 0.2s;
    }
    button.primary { background: var(--color-accent-blue); color: #fff; }
    button.primary:hover:not(:disabled) { background: #60a5fa; }
    button.secondary { background: var(--color-border); color: var(--color-text-primary); }
    button.secondary:hover:not(:disabled) { background: #475569; }
    button.danger { background: var(--color-accent-danger); color: #fff; }
    button.danger:hover:not(:disabled) { background: #f87171; }
    button:disabled { opacity: .5; cursor: default; }
    .meta {
      font-size: 0.75rem;
      opacity: 0.85;
      margin-top: 0.5rem;
      white-space: pre-wrap;
      color: var(--color-text-secondary);
    }
    .scenario-text {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 0.75rem;
      white-space: pre-wrap;
      padding: 0.75rem;
      border-radius: 6px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
    }
    .inject-list {
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px dashed var(--color-border);
      margin-top: 0.75rem;
      padding-top: 0.5rem;
    }
    .inject-item {
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.7rem;
      border-radius: 6px;
      margin-bottom: 0.4rem;
      background: var(--color-bg-primary);
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.2s;
    }
    .inject-item:hover {
        background: #1e2536;
    }
    .inject-item.current {
      border: 1px solid var(--color-accent-blue);
      background: rgba(59, 130, 246, 0.1); /* Subtle blue background for current */
      font-weight: 600;
    }
    .pill {
      font-size: 0.6875rem;
      border-radius: 999px;
      padding: 2px 8px;
      background: #1f2937;
      margin-left: 6px;
      color: var(--color-text-secondary);
    }
    .current-inject {
      white-space: pre-wrap;
      font-size: 0.9375rem;
      line-height: 1.5;
      padding: 0.75rem;
      border-radius: 6px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
    }
    .votes {
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .badge {
      display: inline-block;
      min-width: 22px;
      text-align: center;
      border-radius: 4px;
      padding: 2px 6px;
      background: var(--color-bg-primary);
      margin-right: 8px;
      border: 1px solid var(--color-border);
    }
    .majority-label {
      font-size: 0.8125rem;
      opacity: 0.9;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--color-border);
    }
    .players {
      font-size: 0.875rem;
      max-height: 130px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #aarBox {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.6875rem;
      width: 100%;
      min-height: 90px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
      color: #cbd5e1;
    }
    footer {
      padding: 0.6rem 1.5rem 0.9rem;
      border-top: 1px solid var(--color-border);
      background: var(--color-bg-secondary);
      font-size: 0.6875rem;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }
    #ticker {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.9;
      color: var(--color-text-secondary);
    }
    #footerHint { opacity: 0.7; }
  </style>
</head>
<body>
<header>
  <h1>BLACKFOG TTX – FACILITATOR</h1>
  <div class="session">
    Session: <span id="sessionLabel"></span> · Players: <span id="playerCount"></span>
  </div>
</header>

<main>
  <section>
    <div class="card">
      <h2>Scenario</h2>
      <div class="row">
        <label for="scenarioTemplateSelect">Template</label>
        <select id="scenarioTemplateSelect">
          <option value="shaiHulud">Scenario 1 – Shai-Hulud 2.0 Supply Chain</option>
          <option value="apiAbuse">Scenario 2 – Stolen API Keys & Multi-Actor Abuse</option>
          <option value="lbCompromise">Scenario 3 – Load Balancer Compromise</option>
        </select>
      </div>
      <div class="row">
        <label for="scenarioTitle">Title</label>
        <input type="text" id="scenarioTitle">
        <button class="secondary" id="loadScenarioBtn">Load selected template</button>
      </div>
      <div class="row">
        <textarea id="scenarioDescription" placeholder="Scenario summary..."></textarea>
      </div>
      <div class="row">
        <button class="secondary" id="saveScenarioBtn">Save / update scenario text</button>
        <button class="primary" id="startSessionBtn">Start exercise</button>
        <button class="secondary" id="endSessionBtn">End session</button>
        <button class="danger" id="resetSessionBtn">Reset session</button>
      </div>
      <div id="scenarioText" class="scenario-text"></div>
      <div id="runStatus" class="meta">No scenario loaded yet.</div>
    </div>

    <div class="card">
      <h2>Injects</h2>
      <div class="row">
        <label for="injectTime">Time</label>
        <input type="text" id="injectTime" placeholder="T+00m" style="min-width: 80px;">
        <label for="injectPhase">Phase</label>
        <input type="text" id="injectPhase" placeholder="Intel / Detection / Containment..." style="min-width: 140px;">
        <label for="injectSeverity">Severity</label>
        <input type="text" id="injectSeverity" placeholder="Medium / High / Critical" style="min-width: 140px;">
      </div>
      <div class="row">
        <textarea id="injectNarrative" placeholder="Narrative..."></textarea>
      </div>
      <div class="row" style="margin-top: 12px;">
        <input type="text" id="decisionQuestion" placeholder="Decision question (optional)" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optA" placeholder="Option A" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optB" placeholder="Option B" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optC" placeholder="Option C" style="flex:1;">
      </div>
      <div class="row">
        <button class="secondary" id="updateInjectBtn">Save changes to selected inject</button>
        <button class="primary" id="sendNextBtn" disabled>Send next inject</button>
      </div>
      <div id="injectList" class="inject-list"></div>
    </div>

    <div class="card">
      <h2>Current Inject</h2>
      <div id="currentInjectBox" class="current-inject">No inject sent yet.</div>
    </div>
  </section>

  <section>
    <div class="card">
      <h2>Votes</h2>
      <div id="votesBox" class="votes">No votes yet.</div>
    </div>

    <div class="card">
      <h2>Players</h2>
      <div id="playersBox" class="players">Waiting for players…</div>
    </div>

    <div class="card">
      <h2>AAR</h2>
      <textarea id="aarBox" readonly>Click "Build AAR" after running through the injects.</textarea>
      <div class="row" style="margin-top:6px;">
        <button class="secondary" id="buildAarBtn">Build AAR</button>
        <button class="secondary" id="broadcastAarBtn">Broadcast AAR</button>
      </div>
    </div>
  </section>
</main>

<footer>
  <div id="ticker">Ready. Click "Load template" to push scenario + injects to this session.</div>
  <div id="footerHint">Players join via <code>player.html?s=&lt;session_id&gt;</code></div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getDatabase, ref, set, update, onValue, remove
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // Your existing Firebase project
  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  // ONE hardcoded scenario + inject pack (you can add more later)
  const templateScenarios = {
  "shaiHulud": {
    "title": "Shai-Hulud 2.0 \u2013 Supply Chain Attack",
    "description": "RWS is impacted by a sophisticated supply chain attack against Python packages on PyPI, where trojanised dependencies steal credentials and exfiltrate cloud and source code secrets.",
    "injects": [
      {
        "seq": 1,
        "time": "T+00m",
        "phase": "Intel",
        "severity": "Medium",
        "narrative": "RWS developers report that a CI/CD pipeline job exited with warnings about a dependency mismatch for a Python package used by several internal services. Security researchers publicly disclose that a trojanised version of the same package has appeared on PyPI, containing credential-stealing malware.",
        "decision": {
          "question": "How should RWS respond to the initial intelligence?",
          "options": {
            "A": "Immediately disable CI/CD pipelines using the affected package and begin threat hunting.",
            "B": "Continue operations normally while waiting for PyPI to provide more information.",
            "C": "Ask developers to manually review logs but take no wider action yet."
          }
        }
      },
      {
        "seq": 2,
        "time": "T+20m",
        "phase": "Detection",
        "severity": "High",
        "narrative": "Multiple CI runners begin making outbound network requests to an unfamiliar domain hosted on a foreign VPS provider. Traffic analysis shows bursts of encoded data being exfiltrated, and internal telemetry suggests that AWS temporary tokens may have been compromised.",
        "decision": {
          "question": "What is the appropriate detection-stage response?",
          "options": {
            "A": "Treat the event as active credential theft and escalate to a major incident.",
            "B": "Place monitoring alerts and observe for another 30 minutes.",
            "C": "Ask DevOps to rotate credentials next business day."
          }
        }
      },
      {
        "seq": 3,
        "time": "T+40m",
        "phase": "Containment",
        "severity": "Critical",
        "narrative": "CloudTrail logs show API calls being made with valid but unexpected AWS IAM tokens. The calls enumerate S3 buckets, EKS clusters and Secrets Manager. Some originate from IPs in multiple geographies, suggesting the attacker is using the trojan payload to pivot into cloud infrastructure.",
        "decision": {
          "question": "How should containment be executed?",
          "options": {
            "A": "Immediately revoke all AWS IAM tokens and rotate secrets across all environments.",
            "B": "Revoke only the developer IAM token that first triggered alerts.",
            "C": "Delay major changes until cloud forensics completes a full analysis."
          }