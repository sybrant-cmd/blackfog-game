<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlackFog TTX – Facilitator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      background: #020617;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    header .session {
      font-size: 11px;
      opacity: 0.8;
    }
    main {
      flex: 1;
      padding: 14px 20px 10px;
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 14px;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.55);
    }
    .card h2 {
      margin: 0 0 6px 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #9ca3af;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    label {
      font-size: 12px;
      opacity: 0.85;
    }
    input[type="text"], textarea {
      font-family: inherit;
      font-size: 12px;
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 4px 6px;
    }
    input[type="text"] { min-width: 120px; }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 70px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    button.primary { background: #2563eb; color: #f9fafb; }
    button.secondary { background: #374151; color: #e5e7eb; }
    button:disabled { opacity: .5; cursor: default; }
    .meta {
      font-size: 11px;
      opacity: 0.85;
      margin-top: 4px;
      white-space: pre-wrap;
    }
    .scenario-text {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 6px;
      white-space: pre-wrap;
    }
    .inject-list {
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px dashed #111827;
      margin-top: 6px;
      padding-top: 4px;
    }
    .inject-item {
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 7px;
      border-radius: 8px;
      margin-bottom: 4px;
      background: #020617;
      cursor: pointer;
    }
    .inject-item.current {
      border: 1px solid #2563eb;
      background: radial-gradient(circle at top left, rgba(37,99,235,0.2), #020617 60%);
    }
    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 1px 6px;
      background: #111827;
      margin-left: 4px;
    }
    .current-inject {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.45;
    }
    .votes {
      font-size: 12px;
      line-height: 1.5;
    }
    .badge {
      display: inline-block;
      min-width: 22px;
      text-align: center;
      border-radius: 999px;
      padding: 2px 6px;
      background: #020617;
      margin-right: 6px;
    }
    .majority-label {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 4px;
    }
    .players {
      font-size: 12px;
      max-height: 130px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #aarBox {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      width: 100%;
      min-height: 90px;
    }
    footer {
      padding: 6px 20px 9px;
      border-top: 1px solid #111827;
      background: #020617;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    #ticker {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.9;
    }
    #footerHint { opacity: 0.7; }
  </style>
</head>
<body>
<header>
  <h1>BLACKFOG TTX – FACILITATOR</h1>
  <div class="session">
    Session: <span id="sessionLabel"></span> · Players: <span id="playerCount"></span>
  </div>
</header>

<main>
  <section>
    <div class="card">
      <h2>Scenario</h2>
      <div class="row">
        <label for="scenarioTemplateSelect">Template</label>
        <select id="scenarioTemplateSelect">
          <option value="ransomware">Hospitality – Ransomware</option>
          <option value="payments">Payment Systems Breach</option>
          <option value="insider">Insider Threat – Reservations</option>
        </select>
      </div>
      <div class="row">
        <label for="scenarioTitle">Title</label>
        <input type="text" id="scenarioTitle">
        <button class="secondary" id="loadScenarioBtn">Load selected template</button>
      </div>
      <div class="row">
        <textarea id="scenarioDescription" placeholder="Scenario summary..."></textarea>
      </div>
      <div class="row">
        <button class="secondary" id="saveScenarioBtn">Save / update scenario text</button>
        <button class="primary" id="startSessionBtn">Start exercise</button>
        <button class="secondary" id="endSessionBtn">End session</button>
        <button class="secondary" id="resetSessionBtn">Reset session</button>
      </div>
      <div id="scenarioText" class="scenario-text"></div>
      <div id="runStatus" class="meta">No scenario loaded yet.</div>
    </div>

    <div class="card">
      <h2>Injects</h2>
      <div class="row">
        <label for="injectTime">Time</label>
        <input type="text" id="injectTime" placeholder="T+00m">
        <label for="injectPhase">Phase</label>
        <input type="text" id="injectPhase" placeholder="Intel / Detection / Containment...">
        <label for="injectSeverity">Severity</label>
        <input type="text" id="injectSeverity" placeholder="Medium / High / Critical">
      </div>
      <div class="row">
        <textarea id="injectNarrative" placeholder="Narrative..."></textarea>
      </div>
      <div class="row">
        <input type="text" id="decisionQuestion" placeholder="Decision question (optional)" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optA" placeholder="Option A" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optB" placeholder="Option B" style="flex:1;">
      </div>
      <div class="row">
        <input type="text" id="optC" placeholder="Option C" style="flex:1;">
      </div>
      <div class="row">
        <button class="secondary" id="updateInjectBtn">Save changes to selected inject</button>
        <button class="primary" id="sendNextBtn" disabled>Send next inject</button>
      </div>
      <div id="injectList" class="inject-list"></div>
    </div>

    <div class="card">
      <h2>Current Inject</h2>
      <div id="currentInjectBox" class="current-inject">No inject sent yet.</div>
    </div>
  </section>

  <section>
    <div class="card">
      <h2>Votes</h2>
      <div id="votesBox" class="votes">No votes yet.</div>
    </div>

    <div class="card">
      <h2>Players</h2>
      <div id="playersBox" class="players">Waiting for players…</div>
    </div>

    <div class="card">
      <h2>AAR</h2>
      <textarea id="aarBox" readonly>Click "Build AAR" after running through the injects.</textarea>
      <div class="row" style="margin-top:6px;">
        <button class="secondary" id="buildAarBtn">Build AAR</button>
        <button class="secondary" id="broadcastAarBtn">Broadcast AAR</button>
      </div>
    </div>
  </section>
</main>

<footer>
  <div id="ticker">Ready. Click "Load template" to push scenario + injects to this session.</div>
  <div id="footerHint">Players join via <code>player.html?s=&lt;session_id&gt;</code></div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getDatabase, ref, set, update, onValue
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // Your existing Firebase project
  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  // ONE hardcoded scenario + inject pack (you can add more later)
  const templateScenarios = {
    ransomware: {
      title: "Hospitality Operations Disruption & Ransomware",
      description:
        "A mix of social engineering and weak access controls leads to disruption across room, payment and loyalty systems, ending in ransomware.",
      injects: [
        {
          seq: 1,
          time: "T+00m",
          phase: "Intel",
          severity: "Medium",
          narrative:
            "Service desk receives a call from someone claiming to be from infrastructure, asking for a password reset on a shared admin ID used by property systems.",
          decision: {
            question: "What should the service desk do?",
            options: {
              A: "Enforce strict verification and refuse until identity is confirmed.",
              B: "Reset quickly to be helpful and keep systems running.",
              C: "Reset and email the shared mailbox afterwards."
            }
          }
        },
        {
          seq: 2,
          time: "T+1d",
          phase: "Detection",
          severity: "High",
          narrative:
            "Room key and check-in systems show intermittent failures at multiple sites. Staff are falling back to manual processes and queues are building.",
          decision: {
            question: "How should technology teams respond?",
            options: {
              A: "Declare an incident with operations and central IT immediately.",
              B: "Ask each site to reboot servers and observe.",
              C: "Treat it as likely vendor instability and wait."
            }
          }
        },
        {
          seq: 3,
          time: "T+1d+4h",
          phase: "Containment",
          severity: "Critical",
          narrative:
            "Ransom notes appear on key hospitality and loyalty servers. Some file shares are encrypted. There are traces of credential dumping and lateral movement.",
          decision: {
            question: "What containment approach makes sense?",
            options: {
              A: "Segment and disconnect affected networks quickly, accepting guest impact.",
              B: "Contain only obviously affected servers for now.",
              C: "Delay major moves until ransom note is fully analysed."
            }
          }
        }
      ]
    },
    payments: {
      title: "Payment Systems Breach & PCI Exposure",
      description:
        "Suspicious activity in payment environments escalates from card data scraping to full breach of PCI segments and regulatory exposure.",
      injects: [
        {
          seq: 1,
          time: "T+00m",
          phase: "Intel",
          severity: "Medium",
          narrative:
            "Fraud monitoring partner reports a spike in card-not-present fraud linked to cards recently used at your properties.",
          decision: {
            question: "What is the best immediate response?",
            options: {
              A: "Open an internal security investigation and review payment logs.",
              B: "Treat this as the bank's problem and monitor only.",
              C: "Issue a public statement immediately without confirming details."
            }
          }
        },
        {
          seq: 2,
          time: "T+2h",
          phase: "Detection",
          severity: "High",
          narrative:
            "Security tools detect unusual outbound traffic from POS servers to an unknown external IP during business hours.",
          decision: {
            question: "How should you treat this signal?",
            options: {
              A: "Escalate to an incident, enable packet capture and block suspicious egress.",
              B: "Create a ticket for the next business day review.",
              C: "Assume it is a software update and ignore for now."
            }
          }
        },
        {
          seq: 3,
          time: "T+6h",
          phase: "Containment",
          severity: "Critical",
          narrative:
            "Memory scraping malware is discovered on multiple payment endpoints. There are signs of card data exfiltration over several days.",
          decision: {
            question: "What containment action is appropriate?",
            options: {
              A: "Isolate affected payment systems, switch to fallback processes and engage PCI forensics.",
              B: "Only re-image obviously compromised devices and continue operations.",
              C: "Wait for full malware reverse engineering before acting."
            }
          }
        },
        {
          seq: 4,
          time: "T+1d",
          phase: "Eradication",
          severity: "High",
          narrative:
            "Forensic partners confirm that card data for multiple regions has been accessed, and regulators will need to be notified.",
          decision: {
            question: "How should leadership respond?",
            options: {
              A: "Activate crisis communications and prepare regulator and acquirer notifications.",
              B: "Keep the incident tightly held and avoid written records.",
              C: "Delay notifications until all legal opinions are finalised."
            }
          }
        }
      ]
    },
    insider: {
      title: "Insider Threat in Reservations & Loyalty",
      description:
        "Privileged access in reservations and loyalty systems is abused, leading to potential guest data and points theft.",
      injects: [
        {
          seq: 1,
          time: "T+00m",
          phase: "Intel",
          severity: "Low",
          narrative:
            "Audit logs show an internal user account exporting large reservation reports outside of normal business hours.",
          decision: {
            question: "What is the appropriate first step?",
            options: {
              A: "Flag the activity, preserve logs and start a quiet investigation.",
              B: "Ignore it as likely reporting activity.",
              C: "Immediately disable the account and inform the whole department."
            }
          }
        },
        {
          seq: 2,
          time: "T+1d",
          phase: "Detection",
          severity: "Medium",
          narrative:
            "Loyalty system reports a spike in manual points adjustments linked to the same user ID.",
          decision: {
            question: "How should you respond to this pattern?",
            options: {
              A: "Correlate activity across systems, involve HR and legal, and tighten monitoring.",
              B: "Ask the user informally what they are doing.",
              C: "Silently roll back adjustments but take no further action."
            }
          }
        },
        {
          seq: 3,
          time: "T+1d+4h",
          phase: "Containment",
          severity: "High",
          narrative:
            "Evidence suggests the user has shared credentials and that guest contact data may have been exported.",
          decision: {
            question: "What containment approach makes sense?",
            options: {
              A: "Suspend access, preserve evidence, and initiate a formal insider investigation.",
              B: "Restrict only external access while leaving internal access unchanged.",
              C: "Wait for a full data classification before acting."
            }
          }
        },
        {
          seq: 4,
          time: "T+2d",
          phase: "Eradication / Recovery",
          severity: "Medium",
          narrative:
            "You need to decide how to handle affected guests and potential regulatory questions about insider risk controls.",
          decision: {
            question: "What should leadership focus on now?",
            options: {
              A: "Communicate transparently to affected guests and regulators based on legal advice.",
              B: "Minimise disclosure and focus only on internal disciplinary action.",
              C: "Wait until press or social media picks it up before responding."
            }
          }
        }
      ]
    }
  };

  const app = initializeApp(firebaseConfig);
  