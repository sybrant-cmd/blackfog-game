<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RWS BlackFog – Player v5.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#d72638" />
  <style>
    :root {
      --live: #d72638;
      --black: #020617;
      --panel: #0b1120;
      --stroke: rgba(148,163,184,0.35);
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,0.95), rgba(15,23,42,0.85));
      backdrop-filter: blur(10px);
    }
    h1 { margin: 0; font-size: 18px; }
    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.9);
      margin-left: 8px;
    }
    .pill-live {
      border-color: var(--live);
      color: var(--live);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 14px; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .card {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--stroke);
      box-shadow: 0 16px 42px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
    }
    .card h2 { margin: 0 0 4px 0; font-size: 16px; }
    .card h3 { margin: 0 0 6px 0; font-size: 14px; }
    .standby { font-size: 13px; color: var(--muted); }
    pre {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn:hover { border-color: rgba(248,250,252,0.65); }
    .options { display: grid; gap: 6px; margin-top: 8px; }
    .options button {
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #020617;
      color: var(--text);
      padding: 6px 8px;
      font-size: 13px;
      text-align: left;
      cursor: pointer;
    }
    .options button:hover { border-color: rgba(248,250,252,0.65); }
    .ticker-wrap {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      border-top: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,42,0.95), rgba(15,23,42,1));
      font-size: 12px;
      padding: 4px 10px;
    }
    .ticker-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-right: 12px;
      font-weight: 600;
      color: #fee2e2;
    }
    .ticker-live-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ef4444;
      animation: pulse 1.4s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      60% { transform: scale(1.8); opacity: 0; }
      100% { transform: scale(1); opacity: 0; }
    }
    .ticker {
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100% - 160px);
      vertical-align: bottom;
    }
    .ticker-item {
      margin-right: 18px;
      color: var(--muted);
    }
    .footer-space { height: 40px; }
    .vciso {
      background: radial-gradient(circle at top left, rgba(220,38,38,0.16), #020617);
      border-radius: 14px;
      border: 1px solid rgba(248, 250, 252, 0.12);
      padding: 10px 12px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .vciso-title {
      margin: 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .vciso-title .icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #f97316;
      box-shadow: 0 0 8px rgba(248,113,113,0.75);
    }
    .vciso-msg {
      font-size: 13px;
      line-height: 1.4;
    }
    .vciso-typing {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }
    #timer {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      font-size: 11px;
    }
    .timer-urgent {
      border-color: #f97316;
      color: #fed7aa;
    }
    .card-pop {
      animation: pop 0.25s ease-out;
    }
    @keyframes pop {
      from { transform: scale(0.97); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @media (max-width: 840px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>RWS BlackFog – Player</h1>
    <span class="pill pill-live">LIVE</span>
    <span class="pill" id="sessionPill"></span>
  </div>
  <div class="pill" id="playerPill">Connecting…</div>
</header>

<div class="container">
  <div class="grid">
    <div>
      <section class="card">
        <h2 id="scTitle">Standby – awaiting scenario</h2>
        <p id="scDesc" class="standby">
          Facilitator has not published the scenario yet. Once live, you'll see the RWS crisis context here.
        </p>
        <button id="btnRestart" class="btn">Reset View</button>
      </section>

      <section class="card" id="injCard" style="margin-top:10px; display:none;">
        <h3>Live Inject</h3>
        <pre id="injText" class="standby"></pre>
      </section>

      <section class="card" id="decCard" style="margin-top:10px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Decision</h3>
          <span class="pill" id="timer">--</span>
        </div>
        <p id="decQuestion" class="standby"></p>
        <div class="options">
          <button id="optA"></button>
          <button id="optB"></button>
          <button id="optC"></button>
        </div>
        <p id="decStatus" class="standby" style="margin-top:6px; display:none;">
          ✅ Response recorded. You can discuss your rationale with the facilitator.
        </p>
      </section>
    </div>

    <aside class="vciso">
      <h3 class="vciso-title"><span class="icon"></span> Live Mentor (vCISO)</h3>
      <div id="vcisoFeed">
        <div id="vcisoMsg" class="vciso-msg">
          I’m here to guide you through the exercise. As injects land and you make choices, I’ll react like a human CISO sitting next to you.
        </div>
        <div id="vcisoTyping" class="vciso-typing" style="display:none;">typing…</div>
      </div>
    </aside>
  </div>
</div>

<div class="ticker-wrap">
  <div class="ticker-live">
    <div class="ticker-live-dot"></div>
    <span>LIVESTREAM • RWS CYBER RANGE</span>
  </div>
  <div class="ticker" id="ticker"></div>
</div>
<div class="footer-space"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, onDisconnect, set, update, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const $ = (id) => document.getElementById(id);

  const urlS = new URLSearchParams(location.search).get("s");
  const session = urlS && urlS.trim() ? urlS.trim() : "default";
  $("sessionPill").textContent = "Session " + session;

  // --- Player identity & presence ---
  function uid() { return "P-" + Math.random().toString(36).slice(2, 8).toUpperCase(); }
  const storedId = localStorage.getItem("rws_player_id") || uid();
  localStorage.setItem("rws_player_id", storedId);

  let storedName = localStorage.getItem("rws_player_name");
  if (!storedName) {
    storedName = prompt("Enter your display name for this exercise:", storedId) || storedId;
    localStorage.setItem("rws_player_name", storedName);
  }

  const playerRef = ref(db, `sessions/${session}/players/${storedId}`);
  set(playerRef, {
    id: storedId,
    name: storedName,
    ts: Date.now(),
    status: "online"
  });
  $("playerPill").textContent = storedName + " • Connected";

  // heartbeat
  setInterval(() => {
    update(playerRef, { ts: Date.now(), status: "online" });
  }, 5000);

  // on disconnect mark offline
  onDisconnect(playerRef).update({ status: "offline", ts: Date.now() });

  // --- vCISO brain ---
  const commentBank = {
    Intel: [
      "Okay, this isn’t just background noise. If this landed on my desk at 9am, I’d pause and look twice before moving on.",
      "First question: is this random weirdness, or does it look like someone is deliberately testing our guard rails?",
      "Good instinct here is to slow down and write out what we actually know, not what we’re afraid of."
    ],
    Detection: [
      "This is where the story starts to form. Don’t stare at a single alert, zoom out and see the pattern.",
      "Ask yourself: if this were real, where else in the estate would we expect to see similar signals?",
      "If this were just a false positive, would it be this coordinated across different systems? Usually not."
    ],
    Containment: [
      "This is the uncomfortable part. Someone’s revenue, someone’s KPI, is going to feel this decision.",
      "You almost never get perfect information in time. The skill is picking a move you can explain and sleep with later.",
      "Think in trade-offs: smaller earlier disruption versus larger later incident."
    ],
    Comms: [
      "Technical truth is one thing; how people feel about it is another. Both matter right now.",
      "When you speak up, aim for calm and specific. People can handle bad news, but they hate surprises.",
      "Good comms is like good logging – clear, time-stamped, and honest about what’s known versus suspected."
    ],
    Recovery: [
      "Recovery is when everyone wants to rush back to ‘normal’. It’s also when we quietly decide whether we learned anything.",
      "Declaring victory too early is how you end up with a sequel incident later.",
      "Ask: after this, what will we do differently next time? If the answer is ‘nothing’, that’s a red flag."
    ],
    DecisionAggressive: [
      "You’ve chosen a hard, protective line. That’s often the right instinct in the first hour of an incident.",
      "Aggressive containment buys you time, but it spends goodwill. Make sure you can explain the business trade-off.",
      "This is a ‘protect the crown jewels first’ move. Document that logic explicitly; it will help in the wash-up."
    ],
    DecisionBalanced: [
      "You’ve taken a middle path – some control, some observation. That can work if you stay disciplined about follow-through.",
      "Balance is fine, as long as it doesn’t become indecision in disguise. Set a clear time-box to re-evaluate.",
      "You’re trying to protect both uptime and security. Just be clear what you’ll accept if the risk tilts the wrong way."
    ],
    DecisionConservative: [
      "You’re holding back, which keeps the business happy for now but gives the attacker more room to move.",
      "Conservative moves feel comfortable in the moment. Just remember: if this escalates, today’s caution will be tomorrow’s problem.",
      "If you’re choosing to wait, decide explicitly what new signal would force you to act, and in how much time."
    ],
    Default: [
      "Keep it simple: protect people, protect data, protect the brand. Use that as your north star.",
      "Future you has to write the report. Make decisions that will still make sense when the adrenaline is gone."
    ]
  };

  const extraBank = {
    calm: [
      " Take ten seconds and write down what you actually know, not what you fear.",
      " It’s okay not to have a perfect answer yet – clarity usually comes from the next couple of steps.",
      " Slow down just enough so you don’t miss something obvious in the rush."
    ],
    direct: [
      " At some point someone has to say, ‘We’re doing this.’ Don’t drag the moment out forever.",
      " If you had to choose in the next minute, what’s your honest pick? That’s usually the real answer.",
      " Try not to hide behind tools or process here – this is a judgment call."
    ],
    human: [
      " You’re allowed to feel pressure here. The trick is to let it sharpen you, not paralyse you.",
      " You don’t have to sound clever in the room. You just have to be clear and honest.",
      " Imagine explaining this later to a smart colleague who wasn’t here – what would you say?"
    ]
  };

  function pick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function chooseTone(type, phase, context = {}) {
    const c = context.choice;
    if (phase === "intel") return "calm";
    if (phase === "decision") {
      if (c === "A") return "direct";       // usually aggressive
      if (c === "C") return "human";        // usually conservative / anxious
      return "calm";                        // middle path
    }
    if (phase === "after") return "human";
    return "calm";
  }

  function speakLikeVCISO(type, context = {}) {
    const phase = context.phase || "intel";
    let pool = commentBank[type] || commentBank.Default;

    // if we have a choice, specialise comment type
    if (type === "DecisionFeedback" && context.choice) {
      if (context.choice === "A") pool = commentBank.DecisionAggressive;
      else if (context.choice === "B") pool = commentBank.DecisionBalanced;
      else if (context.choice === "C") pool = commentBank.DecisionConservative;
    }

    const tone = chooseTone(type, phase, context);

    const phaseHints = {
      intel: " Right now the job is to separate signal from noise, not jump to the scariest conclusion.",
      decision: " You’re choosing between imperfect options – that’s completely normal in real incident work.",
      after: " This is the moment to articulate why you chose that path, in plain language."
    };

    const base = pick(pool) + (phaseHints[phase] || "");
    const extras = extraBank[tone] || extraBank.calm;
    const extra = Math.random() < 0.8 ? pick(extras) : "";
    const msg = base + extra;

    const vcisoTyping = $("vcisoTyping");
    const vcisoMsg = $("vcisoMsg");

    vcisoTyping.style.display = "block";
    vcisoMsg.textContent = "";
    let i = 0;
    const step = 3 + Math.floor(Math.random() * 4);

    const interval = setInterval(() => {
      vcisoMsg.textContent = msg.slice(0, i);
      i += step;

      if (i >= msg.length) {
        vcisoMsg.textContent = msg;
        vcisoTyping.style.display = "none";
        clearInterval(interval);
      }
    }, 40);
  }

  // --- Ticker ---
  let tickerItems = [
    { cat: "World", text: "Global markets steady as tech sector rebounds." },
    { cat: "Corporate", text: "RWS continues phased rollout of resilience improvements across IT and OT." },
    { cat: "Cyber", text: "CERT-SG highlights rise in supply-chain attacks targeting hospitality and travel." },
    { cat: "Travel", text: "Regional travel flows remain strong ahead of holiday period." },
    { cat: "Weather", text: "Scattered showers islandwide; operations remain normal." }
  ];

  function renderTicker() {
    const host = $("ticker");
    host.innerHTML = tickerItems.map(item => {
      const safe = (item.text || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return `<span class="ticker-item">${safe} • <strong>${item.cat}</strong></span>`;
    }).join("");
  }
  renderTicker();

  // Reset UI
  function resetView() {
    $("scTitle").textContent = "Standby – awaiting scenario";
    $("scDesc").textContent = "Facilitator has not published the scenario yet. Once live, you'll see the RWS crisis context here.";
    if (window.__rwsTimer) { clearInterval(window.__rwsTimer); window.__rwsTimer = null; }
    $("injCard").style.display = "none";
    $("decCard").style.display = "none";
    $("decStatus").style.display = "none";
    ["optA","optB","optC"].forEach(id => { const b = $(id); b.textContent = ""; b.disabled = false; });
    $("timer").textContent = "--";
  }

  $("btnRestart").onclick = () => resetView();

  // Scenario
  onValue(ref(db, `sessions/${session}/scenario`), snap => {
    const v = snap.val();
    if (!v) return;
    $("scTitle").textContent = v.title || "RWS Cyber Scenario";
    $("scDesc").textContent = v.desc || "";
    speakLikeVCISO("Intel", { phase: "intel" });
  });

  // latest inject
  let currentInjectSeq = null;
  const votedForSeq = {};

  onValue(ref(db, `sessions/${session}/latestInject`), snap => {
    const inj = snap.val();
    if (!inj) return;
    currentInjectSeq = inj.seq || null;

    const injCard = $("injCard");
    injCard.style.display = "block";
    injCard.classList.remove("card-pop");
    void injCard.offsetWidth;
    injCard.classList.add("card-pop");

    $("injText").textContent = `[${inj.time || "T+?m"}] ${inj.text || ""}`;

    // add to ticker
    tickerItems.unshift({ cat: "Breaking", text: inj.text || "New update from SOC." });
    if (tickerItems.length > 20) tickerItems.pop();
    renderTicker();

    const dec = inj.decision || null;
    const decCard = $("decCard");
    const statusEl = $("decStatus");
    const timerEl = $("timer");

    if (!dec || !dec.question) {
      decCard.style.display = "none";
      statusEl.style.display = "none";
      timerEl.textContent = inj.time || "Live";
      speakLikeVCISO(inj.type || "Intel", { phase: "intel", seq: inj.seq });
      return;
    }

    decCard.style.display = "block";
    decCard.classList.remove("card-pop");
    void decCard.offsetWidth;
    decCard.classList.add("card-pop");

    $("decQuestion").textContent = dec.question;
    statusEl.style.display = "none";
    ["optA","optB","optC"].forEach(id => { const b = $(id); b.disabled = false; });
    $("optA").textContent = dec.options && dec.options.A ? "A) " + dec.options.A : "";
    $("optB").textContent = dec.options && dec.options.B ? "B) " + dec.options.B : "";
    $("optC").textContent = dec.options && dec.options.C ? "C) " + dec.options.C : "";

    // simple per-player countdown
    let remaining = 45;
    timerEl.classList.remove("timer-urgent");
    timerEl.textContent = `${remaining}s`;
    if (window.__rwsTimer) clearInterval(window.__rwsTimer);
    window.__rwsTimer = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        clearInterval(window.__rwsTimer);
        timerEl.textContent = "Time up";
        timerEl.classList.add("timer-urgent");
        ["optA","optB","optC"].forEach(id => { $(id).disabled = true; });
        statusEl.style.display = "block";
        statusEl.textContent = "⏱ Time is up for this decision. Discuss what you would have chosen.";
        speakLikeVCISO("DecisionFeedback", { phase: "after", choice: null, seq: inj.seq });
        return;
      }
      if (remaining <= 10) {
        timerEl.classList.add("timer-urgent");
      }
      timerEl.textContent = `${remaining}s`;
    }, 1000);

    speakLikeVCISO(inj.type || "Intel", { phase: "decision", seq: inj.seq });
  });

  // voting
  async function sendVote(choice) {
    if (!currentInjectSeq) return;
    if (votedForSeq[currentInjectSeq]) {
      const statusEl = $("decStatus");
      statusEl.style.display = "block";
      statusEl.textContent = `✅ Your vote for this decision is already recorded as ${votedForSeq[currentInjectSeq]}.`;
      return;
    }
    if (window.__rwsTimer) { clearInterval(window.__rwsTimer); window.__rwsTimer = null; }
    const path = `sessions/${session}/votes/${currentInjectSeq}/${storedId}`;
    const payload = {
      playerId: storedId,
      name: storedName,
      choice,
      at: Date.now()
    };
    await set(ref(db, path), payload);
    votedForSeq[currentInjectSeq] = choice;
    ["optA","optB","optC"].forEach(id => { $(id).disabled = true; });
    const statusEl = $("decStatus");
    statusEl.style.display = "block";
    statusEl.textContent = `✅ You chose option ${choice}. Be ready to explain why.`;
    speakLikeVCISO("DecisionFeedback", { phase: "after", choice, seq: currentInjectSeq });
  }

  $("optA").onclick = () => sendVote("A");
  $("optB").onclick = () => sendVote("B");
  $("optC").onclick = () => sendVote("C");

  // Optionally, listen to AI state to hint difficulty (not strictly required)
  onValue(ref(db, `sessions/${session}/state`), snap => {
    const st = snap.val();
    if (!st) return;
    const label = `L${st.level || 1} • ${st.level === 1 ? "Normal" : st.level === 2 ? "Elevated" : "Severe"} AI difficulty`;
    tickerItems.unshift({ cat: "Range", text: label });
    if (tickerItems.length > 20) tickerItems.pop();
    renderTicker();
  });

  resetView();
</script>
</body>
</html>
