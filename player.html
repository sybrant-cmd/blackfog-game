<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlackFog TTX – Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      background: #020617;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    header .session {
      font-size: 11px;
      opacity: 0.8;
    }
    main {
      flex: 1;
      padding: 14px 20px 10px;
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.1fr);
      gap: 14px;
      align-items: flex-start;
    }
    #mainPane {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    #vcisoCard {
      position: sticky;
      top: 80px;
      align-self: flex-start;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.55);
    }
    .card h2 {
      margin: 0 0 6px 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #9ca3af;
    }
    .scenario {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 6px;
      white-space: pre-wrap;
    }
    .meta {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 6px;
      white-space: pre-wrap;
    }
    .narrative {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.45;
      margin-bottom: 8px;
    }
    .options button {
      display: block;
      width: 100%;
      text-align: left;
      margin-bottom: 6px;
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
    }
    .options button:hover:not(:disabled) { background: #2563eb; }
    .options button.selected { background: #16a34a; }
    .options button:disabled { opacity: 0.7; cursor: default; }
    .aar {
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.4;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    #nameRow {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    #nameRow input {
      flex: 1;
      font-family: inherit;
      font-size: 12px;
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 4px 6px;
    }
    #nameRow button {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }
    footer {
      padding: 6px 20px 9px;
      border-top: 1px solid #111827;
      background: #020617;
      font-size: 11px;
      opacity: 0.85;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    #playerTicker {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #footerHint {
      white-space: nowrap;
      opacity: 0.8;
    }
  </style>
</head>
<body>
<header>
  <h1>BLACKFOG TTX – PLAYER</h1>
  <div class="session">
    Session: <span id="sessionLabel"></span>
  </div>
</header>

<main>
  <section id="mainPane">
    <div class="card">
      <h2>Scenario</h2>
      <div id="nameRow">
        <input id="playerNameInput" type="text" placeholder="Enter your display name">
        <button id="saveNameBtn">Join</button>
      </div>
      <div id="scenarioBox" class="scenario">Waiting for facilitator to start the session...</div>
    </div>

    <div class="card">
      <h2>Current Inject</h2>
      <div id="injectMeta" class="meta">Waiting for facilitator to send an inject…</div>
      <div id="injectNarrative" class="narrative"></div>
      <div id="decisionQuestion" class="narrative" style="font-weight:500;"></div>
      <div id="optionsBox" class="options"></div>
      <div id="answerStatus" class="meta"></div>
    </div>

    <div class="card">
      <h2>AAR</h2>
      <div id="aarBox" class="aar">
        The facilitator's AAR will appear here after the session has ended.
      </div>
    </div>
  </section>

  <aside class="card" id="vcisoCard">
    <h2>vCISO Advisory</h2>
    <div id="vcisoMeta" class="meta">Guidance will appear here for each inject.</div>
    <div id="vcisoBody" class="aar">
      Waiting for the exercise to begin. Once injects start, this panel will highlight key risks and recommended actions from a virtual CISO perspective.
    </div>
  </aside>
</main>

<footer>
  <div id="playerTicker">Waiting for facilitator and scenario…</div>
  <div id="footerHint">Make decisions based on your incident playbook.</div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getDatabase, ref, set, update, onValue, onDisconnect
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const params    = new URLSearchParams(location.search);
  const sessionId = params.get("s") || "default";
  document.getElementById("sessionLabel").textContent = sessionId;

  const scenarioRef    = ref(db, "sessions/" + sessionId + "/scenario");
  const latestInjectRef= ref(db, "sessions/" + sessionId + "/latestInject");
  const aarRef         = ref(db, "sessions/" + sessionId + "/aar");
  const playerRootRef  = ref(db, "sessions/" + sessionId + "/players");

  const playerId       = "p-" + Math.random().toString(36).slice(2, 8);

  const playerNameInput= document.getElementById("playerNameInput");
  const saveNameBtn    = document.getElementById("saveNameBtn");
  const scenarioBox    = document.getElementById("scenarioBox");
  const injectMeta     = document.getElementById("injectMeta");
  const injectNarrative= document.getElementById("injectNarrative");
  const decisionQuestion = document.getElementById("decisionQuestion");
  const optionsBox     = document.getElementById("optionsBox");
  const answerStatus   = document.getElementById("answerStatus");
  const aarBox         = document.getElementById("aarBox");
  const vcisoMeta      = document.getElementById("vcisoMeta");
  const vcisoBody      = document.getElementById("vcisoBody");
  const playerTickerEl = document.getElementById("playerTicker");

  const playerRef = ref(db, "sessions/" + sessionId + "/players/" + playerId);let scenarioStatus = "idle";
  let tickerMessages = [];
  let tickerIndex = 0;
  const cyberNews = [
    "Global hospitality group reports ransomware activity affecting booking and payment systems.",
    "Phishing campaigns continue to target service desk and IT support staff in large enterprises.",
    "Zero-day vulnerabilities in widely used VPN appliances highlight importance of patch management.",
    "Ransomware operators increasingly use data theft and extortion before encryption.",
    "Multi-factor authentication fatigue attacks observed across multiple sectors, including hospitality.",
    "Regulators remind organisations to document incident response and customer communication plans."
  ];
  let playerName  = "";
  let currentSeq  = null;

  // Ensure the facilitator always sees you
  (function initPresence() {
    const now = Date.now();
    set(playerRef, {
      name: "Player-" + playerId,
      status: "pending",
      ts: now
    });
    onDisconnect(playerRef).update({
      status: "offline",
      ts: Date.now()
    });
    setInterval(() => {
      update(playerRef, {
        status: playerName ? "online" : "pending",
        ts: Date.now()
      });
    }, 20000);
  })();

  function joinWithName() {
    playerName = playerNameInput.value.trim() || ("Player-" + playerId);
    playerNameInput.value = playerName;
    saveNameBtn.textContent = "Joined";
    saveNameBtn.disabled = true;
    update(playerRef, {
      name: playerName,
      status: "online",
      ts: Date.now()
    });
  }

  saveNameBtn.onclick = joinWithName;


  function pushPlayerTicker(msg) {
    const ts = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    tickerMessages.unshift("[" + ts + "] " + msg);
    if (tickerMessages.length > 30) tickerMessages.length = 30;
  }

  function startPlayerTicker() {
    if (tickerMessages.length === 0) {
      tickerMessages = cyberNews.slice();
    }
    setInterval(() => {
      if (tickerMessages.length === 0) {
        playerTickerEl.textContent = "Waiting for facilitator and scenario…";
        return;
      }
      tickerIndex = (tickerIndex + 1) % tickerMessages.length;
      playerTickerEl.textContent = tickerMessages[tickerIndex];
    }, 7000);
  }

  function buildVcisoAdvice(inj) {
    const narrative = (inj.narrative || "").toLowerCase();
    const phase = (inj.phase || "").toLowerCase();
    const sev = (inj.severity || "").toLowerCase();

    let meta = "Virtual CISO perspective on this inject.";
    const bodyLines = [];

    if (phase.includes("intel") || narrative.includes("password reset") || narrative.includes("service desk") || narrative.includes("helpdesk")) {
      meta = "Social engineering and identity verification.";
      bodyLines.push("Treat any request to change credentials, especially shared or privileged IDs, as high risk until identity is strongly verified.");
      bodyLines.push("Service desk procedures should enforce call-back, ticket verification, or multi-factor checks before resetting passwords.");
      bodyLines.push("Document the request, log the caller details, and escalate if anything feels unusual or rushed.");
    } else if (phase.includes("detection") || narrative.includes("intermittent failures") || narrative.includes("queues are building")) {
      meta = "From symptoms to structured incident declaration.";
      bodyLines.push("Multiple sites experiencing similar instability is a strong signal of a systemic or security issue, not just a local glitch.");
      bodyLines.push("Move quickly from ad-hoc troubleshooting to a formal incident with clear ownership, communications, and logging/forensics enabled.");
      bodyLines.push("Engage monitoring, check recent changes, and validate whether there are signs of compromise across environments.");
    } else if (phase.includes("containment") || narrative.includes("ransom note") || narrative.includes("encrypted")) {
      meta = "Containment of ransomware and lateral movement.";
      bodyLines.push("Once ransom notes and encryption are observed, assume the attacker has had dwell time and may still have access.");
      bodyLines.push("Prioritise network segmentation, isolation of affected segments, and protection of clean environments and backups.");
      bodyLines.push("Coordinate with legal and communications early, and ensure evidence preservation for later investigation.");
    } else if (phase.includes("business") || narrative.includes("guests") || narrative.includes("media")) {
      meta = "Guest impact, communications, and regulatory exposure.";
      bodyLines.push("Public and guest-facing impact requires a coordinated message that is honest about disruption while avoiding unnecessary speculation.");
      bodyLines.push("Align statements between technology, operations, and corporate communications to maintain trust and meet regulatory expectations.");
      bodyLines.push("Track commitments made to guests and regulators and ensure actions are consistent with those commitments.");
    } else {
      bodyLines.push("Clarify what has changed in the environment, who is impacted, and what data or systems may be at risk.");
      bodyLines.push("Favour decisions that improve visibility and reduce attacker freedom of movement, even if they create short-term operational friction.");
      bodyLines.push("Make sure roles and responsibilities are clear: who leads, who communicates, and who makes risk-based decisions.");
    }

    if (sev.includes("critical")) {
      bodyLines.push("Given the critical severity, senior leadership and crisis management structures should be engaged early.");
    }

    return {
      meta,
      body: bodyLines.join(" ")
    };
  }

  onValue(scenarioRef, snap => {
    const sc = snap.val();
    if (!sc || !sc.title) {
      scenarioBox.textContent = "Waiting for facilitator to load a scenario...";
    } else {
      scenarioBox.textContent = sc.title + "\\n\\n" + (sc.description || "");
    }
  });

  onValue(latestInjectRef, snap => {
    const inj = snap.val();
    if (!inj) {
      injectMeta.textContent = "Waiting for facilitator to send an inject…";
      injectNarrative.textContent = "";
      decisionQuestion.textContent = "";
      optionsBox.innerHTML = "";
      answerStatus.textContent = "";
      vcisoMeta.textContent = "Guidance will appear here for each inject.";
      vcisoBody.textContent = "Waiting for the exercise to begin. Once injects start, this panel will highlight key risks and recommended actions from a virtual CISO perspective.";
      return;
    }
    currentSeq = Number(inj.seq || 0);
    const sev  = inj.severity || "";
    injectMeta.textContent = (inj.time || "") + " • " + (inj.phase || "") + (sev ? " • " + sev : "");
    injectNarrative.textContent = inj.narrative || "";
    decisionQuestion.textContent = "";
    optionsBox.innerHTML = "";
    answerStatus.textContent = "";

    pushPlayerTicker("Inject #" + currentSeq + " received (" + (inj.phase || "Phase") + ").");

    const dec  = inj.decision || {};
    const q    = dec.question || "";
    const opts = dec.options || {};
    decisionQuestion.textContent = q;

    // vCISO advisory is shown immediately when inject arrives
    const advice = buildVcisoAdvice(inj);
    vcisoMeta.textContent = advice.meta;
    vcisoBody.textContent = advice.body;

    ["A","B","C"].forEach(key => {
      const label = opts[key];
      if (!label) return;
      const btn = document.createElement("button");
      btn.textContent = key + ". " + label;
      btn.onclick = () => {
        if (!playerName) {
          alert("Please join with a name first.");
          return;
        }
        const voteRef = ref(db, "sessions/" + sessionId + "/votes/" + currentSeq + "/" + playerId);
        set(voteRef, { choice: key, ts: Date.now() });
        answerStatus.textContent = "You chose option " + key + ".";
        Array.from(optionsBox.children).forEach(b => {
          b.disabled = true;
          if (b === btn) b.classList.add("selected");
        });
      };
      optionsBox.appendChild(btn);
    });
  });

  startPlayerTicker();

  onValue(aarRef, snap => {
    const v = snap.val();
    if (!v || !v.text) {
      aarBox.innerHTML = "";
      return;
    }
    aarBox.innerHTML = v.text.replace(/\n/g, "<br>");
  });
</script>
</body>
</html>
