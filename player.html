<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RWS BlackFog – Player v8.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#d72638" />
  <style>
    :root {
      --live: #d72638;
      --black: #020617;
      --panel: #0b1120;
      --stroke: rgba(148,163,184,0.35);
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,0.95), rgba(15,23,42,0.85));
      backdrop-filter: blur(10px);
    }
    h1 { margin: 0; font-size: 18px; }
    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.9);
      margin-left: 8px;
    }
    .pill-live {
      border-color: var(--live);
      color: var(--live);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 14px; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .card {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--stroke);
      box-shadow: 0 16px 42px rgba(0,0,0,0.6);
      padding: 14px 14px 12px;
    }
    .card h2 { margin: 0 0 4px 0; font-size: 16px; }
    .card h3 { margin: 0 0 6px 0; font-size: 14px; }
    .standby { font-size: 13px; color: var(--muted); }
    pre {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn:hover { border-color: rgba(248,250,252,0.65); }
    .options { display: grid; gap: 6px; margin-top: 8px; }
    .options button {
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #020617;
      color: var(--text);
      padding: 8px 10px;
      font-size: 13px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .options button:hover {
      border-color: rgba(248,250,252,0.85);
      box-shadow: 0 8px 24px rgba(0,0,0,0.7);
      transform: translateY(-1px);
    }
    .options button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .ticker-wrap {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      border-top: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,42,0.95), rgba(15,23,42,1));
      font-size: 12px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ticker-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #fee2e2;
      white-space: nowrap;
    }
    .ticker-live-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ef4444;
      box-shadow: 0 0 8px rgba(248,113,113,0.85);
      animation: pulse 1.4s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      60% { transform: scale(1.8); opacity: 0; }
      100% { transform: scale(1); opacity: 0; }
    }
    .ticker-viewport {
      overflow: hidden;
      flex: 1;
    }
    .ticker-track {
      display: inline-block;
      white-space: nowrap;
      animation: ticker-scroll 40s linear infinite;
    }
    @keyframes ticker-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-item {
      margin-right: 32px;
      color: var(--muted);
    }
    .ticker-item strong {
      color: #e5e7eb;
    }
    .footer-space { height: 40px; }
    .vciso {
      background: radial-gradient(circle at top left, rgba(220,38,38,0.18), #020617);
      border-radius: 14px;
      border: 1px solid rgba(248, 250, 252, 0.12);
      padding: 10px 12px;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .vciso-title {
      margin: 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .vciso-title .icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #f97316;
      box-shadow: 0 0 8px rgba(248,113,113,0.75);
      background: radial-gradient(circle at 30% 30%, #fed7aa, #7f1d1d);
    }
    .vciso-msg {
      font-size: 13px;
      line-height: 1.4;
    }
    .vciso-typing {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }
    #timer {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      font-size: 11px;
    }
    .timer-urgent {
      border-color: #f97316;
      color: #fed7aa;
    }
    .card-pop {
      animation: pop 0.25s ease-out;
    }
    @keyframes pop {
      from { transform: scale(0.97); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    #endCard h3 {
      color: #fecaca;
    }
    @media (max-width: 840px) {
      .grid { grid-template-columns: 1fr; }
      .ticker-wrap { font-size: 11px; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>RWS BlackFog – Player</h1>
    <span class="pill pill-live">LIVE</span>
    <span class="pill" id="sessionPill"></span>
  </div>
  <div class="pill" id="playerPill">Connecting…</div>
</header>

<div class="container">
  <div class="grid">
    <div>
      <section class="card">
        <h2 id="scTitle">Standby – awaiting scenario</h2>
        <p id="scDesc" class="standby">
          Facilitator has not published the scenario yet. Once live, you'll see the RWS crisis context here.
        </p>
        <button id="btnRestart" class="btn">Reset View</button>
      </section>

      <section class="card" id="injCard" style="margin-top:10px; display:none;">
        <h3>Live Inject</h3>
        <pre id="injText" class="standby"></pre>
      </section>

      <section class="card" id="decCard" style="margin-top:10px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Decision</h3>
          <span class="pill" id="timer">--</span>
        </div>
        <p id="decQuestion" class="standby"></p>
        <div class="options">
          <button id="optA"></button>
          <button id="optB"></button>
          <button id="optC"></button>
        </div>
        <p id="decStatus" class="standby" style="margin-top:6px; display:none;">
          ✅ Response recorded. You can discuss your rationale with the facilitator.
        </p>
      </section>

      <section class="card" id="endCard" style="margin-top:10px; display:none;">
        <h3>Exercise Ended</h3>
        <p class="standby">
          This exercise has been closed by the facilitator. Please await the debrief and feedback.
        </p>
      </section>
    </div>

    <aside class="vciso">
      <h3 class="vciso-title"><span class="icon"></span> Live Mentor (vCISO)</h3>
      <div id="vcisoFeed">
        <div id="vcisoMsg" class="vciso-msg">
          I’m here to guide you through the exercise. As injects land and you make choices, I’ll react the way a human CISO might in the room with you.
        </div>
        <div id="vcisoTyping" class="vciso-typing" style="display:none;">typing…</div>
      </div>
    </aside>
  </div>
</div>

<div class="ticker-wrap">
  <div class="ticker-live">
    <div class="ticker-live-dot"></div>
    <span>CNA • CYBER INCIDENT DESK</span>
  </div>
  <div class="ticker-viewport">
    <div class="ticker-track" id="tickerTrack"></div>
  </div>
</div>
<div class="footer-space"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, onDisconnect, set, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const $ = (id) => document.getElementById(id);

  const urlS = new URLSearchParams(location.search).get("s");
  const session = urlS && urlS.trim() ? urlS.trim() : "default";
  $("sessionPill").textContent = "Session " + session;

  // Player identity & presence
  function uid() { return "P-" + Math.random().toString(36).slice(2, 8).toUpperCase(); }
  const storedId = localStorage.getItem("rws_player_id") || uid();
  localStorage.setItem("rws_player_id", storedId);

  let storedName = localStorage.getItem("rws_player_name");
  if (!storedName) {
    storedName = prompt("Enter your display name for this exercise:", storedId) || storedId;
    localStorage.setItem("rws_player_name", storedName);
  }

  const playerRef = ref(db, `sessions/${session}/players/${storedId}`);
  set(playerRef, {
    id: storedId,
    name: storedName,
    ts: Date.now(),
    status: "online"
  });
  $("playerPill").textContent = storedName + " • Connected";

  setInterval(() => {
    update(playerRef, { ts: Date.now(), status: "online" });
  }, 5000);

  onDisconnect(playerRef).update({ status: "offline", ts: Date.now() });

  // vCISO brain: expanded, more dynamic
  const commentBank = {
    Intel: [
      "Okay, this isn’t just background noise. If this landed on my desk mid-morning, I’d pause my email and read it twice.",
      "First question here is simple: is this random weirdness, or does it smell like someone testing our guard rails on purpose?",
      "This is where good teams build muscle memory – noticing the odd pattern before it becomes a headline.",
      "If you feel a bit of unease reading this, that’s usually your pattern-recognition kicking in. Don’t ignore it.",
      "Treat this like the opening scene in a movie. You don’t know the plot yet, but you know the scene matters."
    ],
    Detection: [
      "Now we’re past theory – telemetry is telling a story. Don’t stare at one alert, zoom out and look for repetition.",
      "Ask yourself: if this behaviour is real, where else should we see it in the estate? That question drives good hunting.",
      "If this were a pure false positive, would it line up this neatly across systems? Usually the answer is no.",
      "This is the point where good logging pays off. Thin logs mean thin decisions.",
      "You don’t need to be 100% sure yet, but you do need to be directionally honest about what the data suggests."
    ],
    Containment: [
      "Containment is where someone’s revenue, someone’s KPI, will feel your decision. That’s why it’s uncomfortable.",
      "You almost never get perfect information in time. Your job is to choose a move you can explain and live with later.",
      "Think in trade-offs: a smaller, earlier disruption versus a bigger, later crisis. There is no option with zero pain.",
      "Containment isn’t about fear, it’s about buying time and reducing blast radius so thinking can catch up.",
      "If you’re hesitating, ask: if this is much worse than it looks, will I wish I’d moved faster right now?"
    ],
    Comms: [
      "Technical accuracy is one thing; how people feel about the situation is another. Both matter in the next 30 minutes.",
      "When you brief upwards, aim for calm and specific. People can handle bad news, but they hate confusion.",
      "A solid one-line summary beats a ten-slide deck at this stage. Clarity travels faster than slides.",
      "If your comms sound defensive, people will read that as ‘we’re not in control’. Aim for steady and factual instead.",
      "In crisis calls, the most credible person is usually the one who can say ‘here’s what we know, here’s what we don’t’."
    ],
    Recovery: [
      "Recovery is when everyone wants to rush back to ‘normal’. It’s also where you quietly decide whether anything was learned.",
      "Be careful declaring victory too early. Attackers love environments that celebrate recovery before closing all doors.",
      "Ask yourself: after this, what will we do differently next time? If the answer is ‘not much’, that’s a warning sign.",
      "This is the point to protect future you – write down what actually happened and what you’d change.",
      "The best recovery plans include space for reflection, not just rebuilding servers and closing tickets."
    ],
    DecisionAggressive: [
      "You’ve chosen a hard, protective line. That’s often a good instinct in the first hour of an incident.",
      "Aggressive containment buys you time, but it spends political capital. Make sure you can explain the trade-off clearly.",
      "This is a ‘protect the crown jewels first’ move. Document that logic; it’s your shield in the post-mortem.",
      "You’re signalling that safety and integrity trump short-term convenience. Many CISOs would back that call.",
      "Just remember to pair strong moves with strong communication, or people will only remember the disruption."
    ],
    DecisionBalanced: [
      "You’ve chosen a middle path – some control, some observation. That can work if you stay disciplined.",
      "Balance is fine, as long as it doesn’t become slow-motion indecision. Set a clear checkpoint to re-evaluate.",
      "You’re trying to protect both uptime and security. The key is to be explicit: what risk are you accepting for that?",
      "This kind of choice lives or dies on follow-through. Without follow-up, a ‘balanced’ move just drifts.",
      "If you go down the balanced route, write down what new signal would push you to act more strongly."
    ],
    DecisionConservative: [
      "You’re holding back, which keeps people comfortable in the short term but gives the attacker more room to move.",
      "Conservative moves feel safe. Just be honest that the risk isn’t vanishing – it’s being deferred.",
      "If this escalates, today’s caution could be tomorrow’s uncomfortable conversation. Make sure you’re okay with that.",
      "Sometimes waiting is right, but it should be a deliberate choice, not just hoping for good luck.",
      "If you choose to wait, be specific: how long, and what exactly would make you pull the trigger on stronger action?"
    ],
    Default: [
      "Keep it simple: protect people, protect data, protect the brand. Let that be your compass when the details blur.",
      "Future you will have to write the report. Make decisions that will still make sense when the adrenaline is gone.",
      "Good incident work is less about heroics and more about steady, explainable decisions under pressure.",
      "You don’t need a perfect answer. You need a defendable one, delivered at the right time."
    ]
  };

  const extraBank = {
    calm: [
      " Take ten seconds and write down what you actually know, not what you fear.",
      " It’s okay not to have a perfect answer yet – clarity usually arrives one step at a time.",
      " Slow yourself down just enough that you don’t miss something obvious.",
      " A short, shared summary with your team here will reduce chaos later.",
      " Don’t try to impress anyone – just try to be clear."
    ],
    direct: [
      " At some point someone has to say, ‘We’re doing this.’ Don’t drag that moment out forever.",
      " If you had to choose in the next sixty seconds, what’s your honest pick? That’s usually your real answer.",
      " Try not to hide behind tools or process – this is a judgment call more than a technology one.",
      " Ask yourself what decision you’d back if you were the CISO on call tonight.",
      " Don’t wait for a perfect signal. By then, the attacker will have moved on."
    ],
    human: [
      " You’re allowed to feel pressure here. The trick is to let it sharpen you rather than shut you down.",
      " You don’t have to sound clever in the room; you just have to be honest and concrete.",
      " Imagine explaining this call to a smart colleague tomorrow morning – what story would you want to tell?",
      " The room will follow your energy. If you stay measured, they will too.",
      " Remember, mistakes are inevitable. How you respond and adjust is what people remember."
    ]
  };

  let lastVCISOText = "";

  function pick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function chooseTone(type, phase, context = {}) {
    const c = context.choice;
    if (phase === "intel") return "calm";
    if (phase === "decision") {
      if (c === "A") return "direct";
      if (c === "C") return "human";
      return "calm";
    }
    if (phase === "after") return "human";
    return "calm";
  }

  function speakLikeVCISO(type, context = {}) {
    const phase = context.phase || "intel";
    let pool = commentBank[type] || commentBank.Default;

    if (type === "DecisionFeedback" && context.choice) {
      if (context.choice === "A") pool = commentBank.DecisionAggressive;
      else if (context.choice === "B") pool = commentBank.DecisionBalanced;
      else if (context.choice === "C") pool = commentBank.DecisionConservative;
    }

    const tone = chooseTone(type, phase, context);

    const phaseHints = {
      intel: " Right now the job is to separate signal from noise, not jump to the scariest conclusion.",
      decision: " You’re choosing between imperfect options – that’s normal in real incident work.",
      after: " This is the moment to articulate why you chose that path, in plain language."
    };

    let base, extra, msg;
    let attempts = 0;
    do {
      base = pick(pool) + (phaseHints[phase] || "");
      const extras = extraBank[tone] || extraBank.calm;
      extra = Math.random() < 0.8 ? pick(extras) : "";
      msg = base + extra;
      attempts++;
    } while (msg === lastVCISOText && attempts < 5);

    lastVCISOText = msg;

    const vcisoTyping = $("vcisoTyping");
    const vcisoMsg = $("vcisoMsg");

    vcisoTyping.style.display = "block";
    vcisoMsg.textContent = "";
    let i = 0;
    const step = 3 + Math.floor(Math.random() * 4);

    const interval = setInterval(() => {
      vcisoMsg.textContent = msg.slice(0, i);
      i += step;

      if (i >= msg.length) {
        vcisoMsg.textContent = msg;
        vcisoTyping.style.display = "none";
        clearInterval(interval);
      }
    }, 40);
  }

  // CNA-style ticker
  const worldNews = [
    "Global markets steady as tech and travel sectors show cautious optimism.",
    "Major economies weigh fresh cybersecurity regulations after high-profile breaches.",
    "Key central banks signal a wait-and-see stance on interest rates."
  ];
  const sgNews = [
    "Singapore regulators remind firms to tighten safeguards against third-party cyber risk.",
    "Local hospitality players report strong bookings ahead of regional holiday periods.",
    "Cyber-awareness campaigns continue across critical sectors in Singapore."
  ];
  const cyberNews = [
    "CERT-SG highlights sharp rise in supply-chain attacks targeting hospitality and travel.",
    "Regional SOCs report increased phishing and ransomware activity around month-end cycles.",
    "Analysts warn that business email compromise remains a top financial loss vector."
  ];
  const travelNews = [
    "Air travel volumes remain resilient despite macroeconomic headwinds.",
    "Regional tourism boards collaborate on digital safety guidance for travellers.",
    "Guest expectations for seamless, secure digital journeys continue to grow."
  ];
  const opsNews = [
    "IT and OT teams across the region review incident response playbooks before peak season.",
    "Organisations invest in combined cyber and business continuity exercises.",
    "Boards are asking more detailed questions about cyber-resilience metrics."
  ];

  let tickerItems = [];

  function refreshTickerItems() {
    tickerItems = [];
    tickerItems.push({ cat: "World", text: pick(worldNews) });
    tickerItems.push({ cat: "Singapore", text: pick(sgNews) });
    tickerItems.push({ cat: "Cyber", text: pick(cyberNews) });
    tickerItems.push({ cat: "Travel", text: pick(travelNews) });
    tickerItems.push({ cat: "Business", text: pick(opsNews) });
  }

  function renderTicker() {
    const host = $("tickerTrack");
    if (!host) return;
    const items = tickerItems.length ? tickerItems : [{ cat: "Cyber", text: "Monitoring live exercise telemetry – no external impact." }];
    const html = items.map(item => {
      const safe = (item.text || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return `<span class="ticker-item">${safe} • <strong>${item.cat}</strong></span>`;
    }).join("");
    host.innerHTML = html + html; // duplicate for continuous scroll
  }

  refreshTickerItems();
  renderTicker();
  setInterval(() => { refreshTickerItems(); renderTicker(); }, 25000);

  function resetView() {
    $("scTitle").textContent = "Standby – awaiting scenario";
    $("scDesc").textContent = "Facilitator has not published the scenario yet. Once live, you'll see the RWS crisis context here.";
    if (window.__rwsTimer) { clearInterval(window.__rwsTimer); window.__rwsTimer = null; }
    $("injCard").style.display = "none";
    $("decCard").style.display = "none";
    $("endCard").style.display = "none";
    $("decStatus").style.display = "none";
    ["optA","optB","optC"].forEach(id => { const b = $(id); b.textContent = ""; b.disabled = false; });
    $("timer").textContent = "--";
  }

  $("btnRestart").onclick = () => resetView();

  // Scenario
  onValue(ref(db, `sessions/${session}/scenario`), snap => {
    const v = snap.val();
    if (!v) return;
    $("scTitle").textContent = v.title || "RWS Cyber Scenario";
    $("scDesc").textContent = v.desc || "";
    speakLikeVCISO("Intel", { phase: "intel" });
  });

  let currentInjectSeq = null;

  onValue(ref(db, `sessions/${session}/latestInject`), snap => {
    const inj = snap.val();
    if (!inj) return;
    currentInjectSeq = inj.seq || null;

    const injCard = $("injCard");
    const decCard = $("decCard");
    const endCard = $("endCard");

    if (endCard.style.display === "block") {
      return;
    }

    injCard.style.display = "block";
    injCard.classList.remove("card-pop");
    void injCard.offsetWidth;
    injCard.classList.add("card-pop");

    $("injText").textContent = `[${inj.time || "T+?m"}] ${inj.text || ""}`;

    tickerItems.unshift({ cat: "Breaking", text: inj.text || "New update from SOC." });
    if (tickerItems.length > 20) tickerItems.pop();
    renderTicker();

    const dec = inj.decision || null;
    const statusEl = $("decStatus");
    const timerEl = $("timer");

    if (!dec || !dec.question) {
      decCard.style.display = "none";
      statusEl.style.display = "none";
      timerEl.textContent = inj.time || "Live";
      speakLikeVCISO(inj.type || "Intel", { phase: "intel", seq: inj.seq });
      return;
    }

    decCard.style.display = "block";
    decCard.classList.remove("card-pop");
    void decCard.offsetWidth;
    decCard.classList.add("card-pop");

    $("decQuestion").textContent = dec.question;
    statusEl.style.display = "none";
    ["optA","optB","optC"].forEach(id => { const b = $(id); b.disabled = false; });
    $("optA").textContent = dec.options && dec.options.A ? "A) " + dec.options.A : "";
    $("optB").textContent = dec.options && dec.options.B ? "B) " + dec.options.B : "";
    $("optC").textContent = dec.options && dec.options.C ? "C) " + dec.options.C : "";

    let remaining = 45;
    timerEl.classList.remove("timer-urgent");
    timerEl.textContent = remaining + "s";
    if (window.__rwsTimer) clearInterval(window.__rwsTimer);
    window.__rwsTimer = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        clearInterval(window.__rwsTimer);
        window.__rwsTimer = null;
        timerEl.textContent = "Time up";
        timerEl.classList.add("timer-urgent");
        ["optA","optB","optC"].forEach(id => { $(id).disabled = true; });
        statusEl.style.display = "block";
        statusEl.textContent = "⏱ Time is up for this decision. Discuss what you would have chosen.";
        speakLikeVCISO("DecisionFeedback", { phase: "after", choice: null, seq: inj.seq });
        return;
      }
      if (remaining <= 10) {
        timerEl.classList.add("timer-urgent");
      }
      timerEl.textContent = remaining + "s";
    }, 1000);

    speakLikeVCISO(inj.type || "Intel", { phase: "decision", seq: inj.seq });
  });

  async function sendVote(choice) {
    if (!currentInjectSeq) return;
    if (window.__rwsTimer) { clearInterval(window.__rwsTimer); window.__rwsTimer = null; }
    const path = `sessions/${session}/votes/${currentInjectSeq}/${storedId}`;
    const payload = {
      playerId: storedId,
      name: storedName,
      choice,
      at: Date.now()
    };
    await set(ref(db, path), payload);
    ["optA","optB","optC"].forEach(id => { $(id).disabled = true; });
    const statusEl = $("decStatus");
    statusEl.style.display = "block";
    statusEl.textContent = `✅ You chose option ${choice}. Be ready to explain why.`;
    speakLikeVCISO("DecisionFeedback", { phase: "after", choice, seq: currentInjectSeq });
  }

  $("optA").onclick = () => sendVote("A");
  $("optB").onclick = () => sendVote("B");
  $("optC").onclick = () => sendVote("C");

  onValue(ref(db, `sessions/${session}/ended`), snap => {
    const v = snap.val();
    const endCard = $("endCard");
    if (!v) {
      if (endCard) endCard.style.display = "none";
      return;
    }

    if (window.__rwsTimer) {
      clearInterval(window.__rwsTimer);
      window.__rwsTimer = null;
    }

    $("injCard").style.display = "none";
    $("decCard").style.display = "none";
    $("decStatus").style.display = "none";
    ["optA","optB","optC"].forEach(id => {
      const b = $(id);
      if (b) b.disabled = true;
    });

    endCard.style.display = "block";
    speakLikeVCISO("Recovery", { phase: "after" });
  });

  onValue(ref(db, `sessions/${session}/state`), snap => {
    const st = snap.val();
    if (!st) return;
    const lvl = st.level || 1;
    const label = lvl === 1 ? "Normal" : lvl === 2 ? "Elevated" : lvl === 3 ? "High" : lvl === 4 ? "Severe" : "Crisis";
    tickerItems.unshift({ cat: "Range", text: `AI difficulty is now ${label}.` });
    if (tickerItems.length > 20) tickerItems.pop();
    renderTicker();
  });

  resetView();
</script>
</body>
</html>
