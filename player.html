<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BlackFog TTX – Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      background: #020617;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    header .session {
      font-size: 11px;
      opacity: 0.8;
    }
    main {
      flex: 1;
      padding: 14px 20px 10px;
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.1fr);
      gap: 14px;
      align-items: flex-start;
    }
    #mainPane {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    #vcisoCard {
      position: sticky;
      top: 80px;
      align-self: flex-start;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.55);
    }
    .card h2 {
      margin: 0 0 6px 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #9ca3af;
    }
    .scenario {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 6px;
      white-space: pre-wrap;
    }
    .meta {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 6px;
      white-space: pre-wrap;
    }
    .narrative {
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.45;
      margin-bottom: 8px;
    }
    .options button {
      display: block;
      width: 100%;
      text-align: left;
      margin-bottom: 6px;
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
    }
    .options button:hover:not(:disabled) { background: #2563eb; }
    .options button.selected { background: #16a34a; }
    .options button:disabled { opacity: 0.7; cursor: default; }
    .aar {
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.4;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    #nameRow {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    #nameRow input {
      flex: 1;
      font-family: inherit;
      font-size: 12px;
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 4px 6px;
    }
    #nameRow button {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }
    footer {
      padding: 6px 20px 9px;
      border-top: 1px solid #111827;
      background: #020617;
      font-size: 11px;
      opacity: 0.85;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    #playerTicker {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #footerHint {
      white-space: nowrap;
      opacity: 0.8;
    }
  </style>
</head>
<body>
<header>
  <h1>BLACKFOG TTX – PLAYER</h1>
  <div class="session">
    Session: <span id="sessionLabel"></span>
  </div>
</header>

<main>
  <section id="mainPane">
    <div class="card">
      <h2>Scenario</h2>
      <div id="nameRow">
        <input id="playerNameInput" type="text" placeholder="Enter your display name">
        <button id="saveNameBtn">Join</button>
      </div>
      <div id="scenarioBox" class="scenario">Waiting for facilitator to start the session...</div>
    </div>

    <div class="card">
      <h2>Current Inject</h2>
      <div id="injectMeta" class="meta">Waiting for facilitator to send an inject…</div>
      <div id="injectNarrative" class="narrative"></div>
      <div id="decisionQuestion" class="narrative" style="font-weight:500;"></div>
      <div id="optionsBox" class="options"></div>
      <div id="answerStatus" class="meta"></div>
    </div>

    <div class="card" id="aarCard">
      <h2>AAR</h2>
      <div id="aarBox" class="aar">
        The facilitator's AAR will appear here after the session has ended.
      </div>
    </div>
  </section>

  <aside class="card" id="vcisoCard">
    <h2>vCISO Advisory</h2>
    <div id="vcisoMeta" class="meta">Guidance will appear here for each inject.</div>
    <div id="vcisoBody" class="aar">
      Waiting for the exercise to begin. Once injects start, this panel will highlight key risks and recommended actions from a virtual CISO perspective.
    </div>
  </aside>
</main>

<footer>
  <div id="playerTicker">Waiting for facilitator and scenario…</div>
  <div id="footerHint">Make decisions based on your incident playbook.</div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getDatabase, ref, set, update, onValue, onDisconnect
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjnfJOD8bK-PLKiFOYzC8Yz2S7g1hM1W0",
    authDomain: "rws-blackfog-game.firebaseapp.com",
    databaseURL: "https://rws-blackfog-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rws-blackfog-game",
    storageBucket: "rws-blackfog-game.firebasestorage.app",
    messagingSenderId: "473543964029",
    appId: "1:473543964029:web:4bc0db33634ed2f8894814"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const params    = new URLSearchParams(location.search);
  const sessionId = params.get("s") || "default";
  document.getElementById("sessionLabel").textContent = sessionId;

  // --- NEW: Player ID and Name persistence via Local Storage ---
  let playerId = localStorage.getItem('playerId_' + sessionId);
  let playerName = localStorage.getItem('playerName_' + sessionId);

  if (!playerId) {
      playerId = "p-" + Math.random().toString(36).slice(2, 8);
      localStorage.setItem('playerId_' + sessionId, playerId);
  }
  // --- END NEW ---

  const scenarioRef    = ref(db, "sessions/" + sessionId + "/scenario");
  const latestInjectRef= ref(db, "sessions/" + sessionId + "/latestInject");
  const aarRef         = ref(db, "sessions/" + sessionId + "/aar");
  const playerRootRef  = ref(db, "sessions/" + sessionId + "/players");
  const playerRef = ref(db, "sessions/" + sessionId + "/players/" + playerId);

  const playerNameInput= document.getElementById("playerNameInput");
  const saveNameBtn    = document.getElementById("saveNameBtn");
  const scenarioBox    = document.getElementById("scenarioBox");
  const injectMeta     = document.getElementById("injectMeta");
  const injectNarrative= document.getElementById("injectNarrative");
  const decisionQuestion = document.getElementById("decisionQuestion");
  const optionsBox     = document.getElementById("optionsBox");
  const answerStatus   = document.getElementById("answerStatus");
  const aarBox         = document.getElementById("aarBox");
  const aarCard        = document.getElementById("aarCard");
  const vcisoMeta      = document.getElementById("vcisoMeta");
  const vcisoBody      = document.getElementById("vcisoBody");
  const playerTickerEl = document.getElementById("playerTicker");

let scenarioStatus = "idle";
let currentSeq = null;
  let tickerMessages = [];
  let tickerIndex = 0;
  const cyberNews = [
    "Global hospitality group reports ransomware activity affecting booking and payment systems.",
    "Phishing campaigns continue to target service desk and IT support staff in large enterprises.",
    "Zero-day vulnerabilities in widely used VPN appliances highlight importance of patch management.",
    "Ransomware operators increasingly use data theft and extortion before encryption.",
    "Multi-factor authentication fatigue attacks observed across multiple sectors, including hospitality.",
    "Regulators remind organisations to document incident response and customer communication plans."
  ];
  // Ensure the facilitator always sees you
  if (aarCard) aarCard.style.display = "none";

  // --- NEW: Pre-fill name and join status if name exists ---
  if (playerName) {
      playerNameInput.value = playerName;
      saveNameBtn.textContent = "Joined";
      saveNameBtn.disabled = true;
  }
  // --- END NEW ---

  (function initPresence() {
    const now = Date.now();
    
    // Set initial name and status based on persistence
    const initialName = playerName || ("Player-" + playerId);
    const initialStatus = playerName ? "online" : "pending";

    set(playerRef, {
      name: initialName,
      status: initialStatus,
      ts: now
    });
    onDisconnect(playerRef).update({
      status: "offline",
      ts: Date.now()
    });
    setInterval(() => {
      update(playerRef, {
        status: playerName ? "online" : "pending",
        ts: Date.now()
      });
    }, 20000);
  })();

  function joinWithName() {
    playerName = playerNameInput.value.trim() || ("Player-" + playerId);
    // NEW: Save name to local storage
    localStorage.setItem('playerName_' + sessionId, playerName);
    
    playerNameInput.value = playerName;
    saveNameBtn.textContent = "Joined";
    saveNameBtn.disabled = true;
    update(playerRef, {
      name: playerName,
      status: "online",
      ts: Date.now()
    });
  }

  saveNameBtn.onclick = joinWithName;


  function pushPlayerTicker(msg) {
    const ts = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    tickerMessages.unshift("[" + ts + "] " + msg);
    if (tickerMessages.length > 30) tickerMessages.length = 30;
  }

  function startPlayerTicker() {
    if (tickerMessages.length === 0) {
      tickerMessages = cyberNews.slice();
    }
    setInterval(() => {
      if (tickerMessages.length === 0) {
        playerTickerEl.textContent = "Waiting for facilitator and scenario…";
        return;
      }
      tickerIndex = (tickerIndex + 1) % tickerMessages.length;
      playerTickerEl.textContent = tickerMessages[tickerIndex];
    }, 7000);
  }

  function buildVcisoAdvice(inj) {
    const narrative = (inj.narrative || "").toLowerCase();
    const phase = (inj.phase || "").toLowerCase();
    const sev = (inj.severity || "").toLowerCase();

    let meta = "Virtual CISO perspective on this inject.";
    const bodyLines = [];

    if (phase.includes("intel") || narrative.includes("password reset") || narrative.includes("service desk") || narrative.includes("helpdesk")) {
      meta = "Social engineering and identity verification.";
      bodyLines.push("Treat any request to change credentials, especially shared or privileged IDs, as high risk until identity is strongly verified.");
      bodyLines.push("Service desk procedures should enforce call-back, ticket verification, or multi-factor checks before resetting passwords.");
      bodyLines.push("Document the request, log the caller details, and escalate if anything feels unusual or rushed.");
    } else if (phase.includes("detection") || narrative.includes("intermittent failures") || narrative.includes("queues are building")) {
      meta = "From symptoms to structured incident declaration.";
      bodyLines.push("Multiple sites experiencing similar instability is a strong signal of a systemic or security issue, not just a local glitch.");
      bodyLines.push("Move quickly from ad-hoc troubleshooting to a formal incident with clear ownership, communications, and logging/forensics enabled.");
      bodyLines.push("Engage monitoring, check recent changes, and validate whether there are signs of compromise across environments.");
    } else if (phase.includes("containment") || narrative.includes("ransom note") || narrative.includes("encrypted")) {
      meta = "Containment of ransomware and lateral movement.";
      bodyLines.push("Once ransom notes and encryption are observed, assume the attacker has had dwell time and may still have access.");
      bodyLines.push("Prioritise network segmentation, isolation of affected segments, and protection of clean environments and backups.");
      bodyLines.push("Coordinate with